# structecs ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

**æœ€çµ‚æ›´æ–°: 2025å¹´11æœˆ1æ—¥**  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Œæˆã€æœ¬ç•ªæº–å‚™å®Œäº†**

---

## ğŸ“– ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [è¨­è¨ˆæ€æƒ³](#è¨­è¨ˆæ€æƒ³)
3. [ã‚³ã‚¢ã‚³ãƒ³ã‚»ãƒ—ãƒˆ](#ã‚³ã‚¢ã‚³ãƒ³ã‚»ãƒ—ãƒˆ)
4. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©³ç´°](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©³ç´°)
5. [ä¸¦è¡Œå‡¦ç†ãƒ¢ãƒ‡ãƒ«](#ä¸¦è¡Œå‡¦ç†ãƒ¢ãƒ‡ãƒ«)
6. [ãƒ¡ãƒ¢ãƒªãƒ¢ãƒ‡ãƒ«](#ãƒ¡ãƒ¢ãƒªãƒ¢ãƒ‡ãƒ«)
7. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§)
8. [ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ](#ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ)
9. [ä½¿ç”¨ã™ã¹ãã‚±ãƒ¼ã‚¹](#ä½¿ç”¨ã™ã¹ãã‚±ãƒ¼ã‚¹)
10. [æŠ€è¡“çš„åˆ¶ç´„ã¨è¨­è¨ˆåˆ¤æ–­](#æŠ€è¡“çš„åˆ¶ç´„ã¨è¨­è¨ˆåˆ¤æ–­)
11. [Additional Components: å‹•çš„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ](#7-additional-components-å‹•çš„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ)

---

## æ¦‚è¦

**structecs**ã¯ã€å¾“æ¥ã®ECSï¼ˆEntity Component Systemï¼‰ã®æŸ”è»Ÿæ€§ã‚’çŠ ç‰²ã«ã—ãªã„ã€éšå±¤çš„ãƒ‡ãƒ¼ã‚¿æ§‹é€ å¯¾å¿œã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç®¡ç†ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚

### æ ¸å¿ƒçš„ç‰¹å¾´

- **éšå±¤çš„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**: OOPã®ã‚ˆã†ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚¹ãƒˆå¯èƒ½
- **ãƒ•ãƒ©ãƒƒãƒˆãªã‚¢ã‚¯ã‚»ã‚¹**: ãƒã‚¹ãƒˆã®æ·±ã•ã«é–¢ã‚ã‚‰ãšä»»æ„ã®å‹ã‚’ç›´æ¥ã‚¯ã‚¨ãƒª
- **ãƒ­ãƒƒã‚¯ãƒ•ãƒªãƒ¼ä¸¦è¡Œå‡¦ç†**: ç´°ç²’åº¦ãƒ­ãƒƒã‚¯ã«ã‚ˆã‚‹é«˜ä¸¦è¡Œæ€§
- **ã‚¼ãƒ­ã‚³ã‚¹ãƒˆæŠ½è±¡åŒ–**: ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã‚ªãƒ•ã‚»ãƒƒãƒˆè¨ˆç®—ã«ã‚ˆã‚‹ç›´æ¥ãƒ¡ãƒ¢ãƒªã‚¢ã‚¯ã‚»ã‚¹
- **Systemã®æŠ¼ã—ä»˜ã‘ãªã—**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªç”±ã«ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¨˜è¿°

### ä»–ã®ECSã¨ã®é•ã„

```
å¾“æ¥ã®ECS (Bevy, specs, hecs):
â”œâ”€ Entity: ID
â”œâ”€ Component: ç‹¬ç«‹ã—ãŸå‹ï¼ˆãƒ•ãƒ©ãƒƒãƒˆï¼‰
â”œâ”€ System: å¼·åˆ¶çš„ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
â””â”€ Query: ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚å‹å®‰å…¨

structecs:
â”œâ”€ Entity: ID
â”œâ”€ Component: æ§‹é€ ä½“ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆéšå±¤å¯ï¼‰
â”œâ”€ System: ãªã—ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªç”±ã«å®Ÿè£…ï¼‰
â””â”€ Query: å®Ÿè¡Œæ™‚å‹æŠ½å‡ºï¼ˆå‹•çš„ã‹ã¤æŸ”è»Ÿï¼‰
```

---

## è¨­è¨ˆæ€æƒ³

### 1. ãƒ‡ãƒ¼ã‚¿ã¯éšå±¤çš„ã€ã‚¢ã‚¯ã‚»ã‚¹ã¯ãƒ•ãƒ©ãƒƒãƒˆ

**å•é¡Œæ„è­˜:**
ã‚²ãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ï¼ˆç‰¹ã«Minecraftã®ã‚ˆã†ãªè¤‡é›‘ãªéšå±¤ã‚’æŒã¤ã‚‚ã®ï¼‰ã§ã¯ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®é–¢ä¿‚æ€§ãŒè‡ªç„¶ã«éšå±¤æ§‹é€ ã‚’å½¢æˆã—ã¾ã™ã€‚

```rust
Entity
  â”œâ”€ name: String
  â””â”€ position: Vec3

LivingEntity
  â”œâ”€ entity: Entity     // ç¶™æ‰¿ã®ã‚ˆã†ãªé–¢ä¿‚
  â”œâ”€ health: u32
  â””â”€ max_health: u32

Player
  â”œâ”€ living: LivingEntity
  â”œâ”€ inventory: Inventory
  â””â”€ game_mode: GameMode
```

**å¾“æ¥ã®ECSã§ã®å•é¡Œ:**

- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯å®Œå…¨ã«ãƒ•ãƒ©ãƒƒãƒˆ
- ç¶™æ‰¿ã‚„åŒ…å«é–¢ä¿‚ã‚’è¡¨ç¾ã—ã«ãã„
- åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’è¤‡æ•°ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«é‡è¤‡ã—ã¦æŒã¤å¿…è¦ãŒã‚ã‚‹

**structecsã®è§£æ±ºç­–:**

```rust
#[derive(Extractable)]
pub struct Entity {
    pub name: String,
    pub position: Vec3,
}

#[derive(Extractable)]
#[extractable(entity)]  // â† Entityã‚’æ˜ç¤ºçš„ã«æŠ½å‡ºå¯èƒ½ã¨ã—ã¦ãƒãƒ¼ã‚¯
pub struct LivingEntity {
    pub entity: Entity,
    pub health: u32,
    pub max_health: u32,
}

#[derive(Extractable)]
#[extractable(living)]  // â† LivingEntityã‚’æ˜ç¤ºçš„ã«æŠ½å‡ºå¯èƒ½ã¨ã—ã¦ãƒãƒ¼ã‚¯
pub struct Player {
    pub living: LivingEntity,
    pub inventory: Inventory,
    pub game_mode: GameMode,
}

// struct/enumå˜ä½ã§ã‚¯ã‚¨ãƒªå¯èƒ½ï¼ˆéšå±¤å†…ã®æ˜ç¤ºçš„ã«ãƒãƒ¼ã‚¯ã•ã‚ŒãŸå‹ï¼‰
for (id, entity) in world.query::<Entity>() {
    // Entity, LivingEntity.entity, Player.living.entity ã«ã‚¢ã‚¯ã‚»ã‚¹
    println!("Name: {}", entity.name);
}

for (id, living) in world.query::<LivingEntity>() {
    // LivingEntity, Player.living ã«ã‚¢ã‚¯ã‚»ã‚¹
    println!("Health: {}/{}", living.health, living.max_health);
}

for (id, player) in world.query::<Player>() {
    // Playerå…¨ä½“ã«ã‚¢ã‚¯ã‚»ã‚¹
    println!("Player: {}", player.living.entity.name);
}
```

**é‡è¦ãªåˆ¶ç´„:**

- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯**struct/enumå˜ä½**ã§ã®ã¿æŠ½å‡ºå¯èƒ½
- å€‹åˆ¥ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆ`u32`, `String`ãªã©ï¼‰ã¯æŠ½å‡ºã§ããªã„
- ãƒã‚¹ãƒˆã—ãŸå‹ã‚‚`#[extractable(field_name)]`ã§æ˜ç¤ºçš„ã«ãƒãƒ¼ã‚¯ã—ãªã„é™ã‚ŠæŠ½å‡ºä¸å¯

**ã“ã®è¨­è¨ˆã®ç†ç”±:**

1. **New type patternã¨ã®è¡çªå›é¿**

   ```rust
   struct Health(u32);
   struct Mana(u32);
   // ã‚‚ã—u32ã§ç›´æ¥ã‚¯ã‚¨ãƒªã§ããŸã‚‰ã€ã©ã¡ã‚‰ã®u32ã‹åŒºåˆ¥ä¸å¯èƒ½
   ```

2. **æ˜ç¢ºãªæ„å›³**

   ```rust
   struct Player {
       inventory: Mutex<Vec<Item>>,
       stats: Mutex<Vec<Stat>>,
   }
   // Mutex<Vec<Item>>ã¨Mutex<Vec<Stat>>ã¯ç•°ãªã‚‹æ„å‘³
   // structå˜ä½ãªã‚‰æ··åŒã—ãªã„
   ```

3. **å‹å®‰å…¨æ€§**
   - ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å‹ã®ã‚¯ã‚¨ãƒªã¯æ›–æ˜§
   - struct/enumå˜ä½ãªã‚‰æ˜ç¢ºãªæ„å‘³ã‚’æŒã¤

### 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¯å¤‰æ€§ã‚’åˆ¶å¾¡ã™ã‚‹

**è¨­è¨ˆåˆ¤æ–­:** Worldã¯**èª­ã¿å–ã‚Šå°‚ç”¨ã‚¢ã‚¯ã‚»ã‚¹**ã®ã¿ã‚’æä¾›ã—ã€å¯å¤‰æ€§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç®¡ç†ã™ã‚‹ã€‚

**ç†ç”±:**

1. **æŸ”è»Ÿæ€§**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœ€é©ãªãƒ­ãƒƒã‚¯æˆ¦ç•¥ã‚’é¸æŠã§ãã‚‹
2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: Worldå…¨ä½“ã‚’ãƒ­ãƒƒã‚¯ã™ã‚‹å¿…è¦ãŒãªã„
3. **ä¸¦è¡Œæ€§**: è¤‡æ•°ã‚¹ãƒ¬ãƒƒãƒ‰ãŒåŒæ™‚ã«Worldã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

**å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³:**

```rust
// ãƒ‘ã‚¿ãƒ¼ãƒ³1: Atomicã‚’ä½¿ã†ï¼ˆãƒ­ãƒƒã‚¯ãƒ•ãƒªãƒ¼ï¼‰
#[derive(Extractable)]
pub struct Player {
    pub name: String,
    pub health: AtomicU32,  // â† ãƒ­ãƒƒã‚¯ãƒ•ãƒªãƒ¼ãªå¤‰æ›´
}

for (id, health) in world.query::<AtomicU32>() {
    health.fetch_add(10, Ordering::Relaxed);
}

// ãƒ‘ã‚¿ãƒ¼ãƒ³2: Mutexã‚’ä½¿ã†ï¼ˆç´°ç²’åº¦ãƒ­ãƒƒã‚¯ï¼‰
#[derive(Extractable)]
pub struct Inventory {
    pub items: Mutex<Vec<Item>>,  // â† å¿…è¦ãªæ™‚ã ã‘ãƒ­ãƒƒã‚¯
}

for (id, inventory) in world.query::<Mutex<Vec<Item>>>() {
    let mut items = inventory.lock().unwrap();
    items.push(new_item);
}

// ãƒ‘ã‚¿ãƒ¼ãƒ³3: RwLockã‚’ä½¿ã†ï¼ˆèª­ã¿å–ã‚Š/æ›¸ãè¾¼ã¿åˆ†é›¢ï¼‰
#[derive(Extractable)]
pub struct Position {
    pub coords: RwLock<Vec3>,
}

// è¤‡æ•°ã‚¹ãƒ¬ãƒƒãƒ‰ã§åŒæ™‚ã«èª­ã¿å–ã‚Šå¯èƒ½
for (id, pos) in world.query::<RwLock<Vec3>>() {
    let coords = pos.read().unwrap();
    println!("Position: {:?}", *coords);
}
```

**ãªãœ`query_mut()`ã‚’æä¾›ã—ãªã„ã®ã‹:**

```rust
// ã‚‚ã—ã“ã‚“ãªAPIãŒã‚ã£ãŸã‚‰...
for (id, mut player) in world.query_mut::<Player>() {
    player.health += 10;  // â† ã“ã®é–“ã€Worldå…¨ä½“ãŒãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹
}
```

å•é¡Œç‚¹:

- Worldã®**ã™ã¹ã¦ã®ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—**ãŒãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹
- ä»–ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã¯èª­ã¿å–ã‚Šã™ã‚‰ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹
- ç´°ç²’åº¦åˆ¶å¾¡ãŒä¸å¯èƒ½ï¼ˆä¸€éƒ¨ã ã‘Atomicã«ã™ã‚‹ãªã©ï¼‰

### 3. Systemã‚’å¼·åˆ¶ã—ãªã„

**å“²å­¦:** ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¯ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã«å¾¹ã—ã€ãƒ­ã‚¸ãƒƒã‚¯ã®æ§‹é€ ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å§”ã­ã‚‹ã€‚

å¾“æ¥ã®ECS:

```rust
// Systemã‚’å®šç¾©ã—ãªã„ã¨ã„ã‘ãªã„
fn movement_system(query: Query<&mut Position, &Velocity>) {
    for (mut pos, vel) in query.iter_mut() {
        pos.x += vel.x;
    }
}

// Scheduleã«ç™»éŒ²
app.add_system(movement_system);
```

structecs:

```rust
// å¥½ããªã‚ˆã†ã«æ›¸ã‘ã‚‹
fn update_physics(world: &World, delta: f32) {
    for (id, pos) in world.query::<RwLock<Vec3>>() {
        let vel = world.extract_component::<Vec3>(&id).unwrap();
        let mut pos = pos.write().unwrap();
        pos.x += vel.x * delta;
    }
}

// ã¾ãŸã¯
impl GameServer {
    fn tick(&self) {
        self.update_players();
        self.update_monsters();
        self.handle_collisions();
        // è‡ªç”±ã«åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼
    }
}
```

---

## ã‚³ã‚¢ã‚³ãƒ³ã‚»ãƒ—ãƒˆ

### 1. Entity: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è­˜åˆ¥å­

```rust
#[derive(Hash, Eq, PartialEq, Debug, Clone, Copy)]
pub struct EntityId {
    pub(crate) id: u32,
}
```

**è²¬å‹™:**

- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ä¸€æ„è­˜åˆ¥
- ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã¸ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

**ç‰¹æ€§:**

- `Copy`: è»½é‡ã€ã‚¹ã‚¿ãƒƒã‚¯ã‚³ãƒ”ãƒ¼å¯èƒ½
- `Hash`: HashMap/DashMapã®ã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨
- 32bit: 40å„„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¾ã§ã‚µãƒãƒ¼ãƒˆ

### 2. Component: æŠ½å‡ºå¯èƒ½ãªå‹

structecsã§ã¯ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯**æ§‹é€ ä½“ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**ã§ã™ã€‚

```rust
pub trait Extractable: 'static + Sized {
    const METADATA_LIST: &'static [ExtractionMetadata];
}
```

**ExtractionMetadata:** ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ç”Ÿæˆã•ã‚Œã‚‹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿

```rust
pub enum ExtractionMetadata {
    // ã“ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãã®ã‚‚ã®ã‚’æŠ½å‡ºå¯èƒ½
    Target {
        type_id: TypeId,
        offset: usize,
    },
    // ãƒã‚¹ãƒˆã—ãŸæ§‹é€ ä½“ã§ã€å†…éƒ¨ã‚’ã•ã‚‰ã«æŠ½å‡ºå¯èƒ½
    Nested {
        type_id: TypeId,
        offset: usize,
        nested: &'static [ExtractionMetadata],
    },
}
```

**ä¾‹:**

```rust
#[derive(Extractable)]
pub struct Entity {
    pub name: String,    // offset: 0
    pub health: u32,     // offset: 24 (Stringã¯24ãƒã‚¤ãƒˆ)
}
```

ç”Ÿæˆã•ã‚Œã‚‹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿:

```rust
const METADATA_LIST: &[ExtractionMetadata] = &[
    ExtractionMetadata::Target {
        type_id: TypeId::of::<String>(),
        offset: 0,
    },
    ExtractionMetadata::Target {
        type_id: TypeId::of::<u32>(),
        offset: 24,
    },
];
```

### 3. Extractor: å‹æŠ½å‡ºã‚¨ãƒ³ã‚¸ãƒ³

```rust
pub struct Extractor {
    offsets: HashMap<TypeId, usize>,
    dropper: unsafe fn(NonNull<u8>),
}
```

**è²¬å‹™:**

1. å‹ã‹ã‚‰ãƒ¡ãƒ¢ãƒªã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è¨ˆç®—ï¼ˆäº‹å‰è¨ˆç®—æ¸ˆã¿ï¼‰
2. ãƒã‚¤ãƒ³ã‚¿æ¼”ç®—ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹
3. ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®å®‰å…¨ãªãƒ‰ãƒ­ãƒƒãƒ—

**å‹•ä½œåŸç†:**

```rust
// Playeræ§‹é€ ä½“ã®ãƒ¡ãƒ¢ãƒªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
Player {
    entity: Entity {      // offset: 0
        name: String,     // offset: 0
    },
    health: u32,          // offset: 24
}

// ExtractorãŒä¿æŒã™ã‚‹ã‚ªãƒ•ã‚»ãƒƒãƒˆãƒãƒƒãƒ—
offsets = {
    TypeId(String): 0,    // entity.name
    TypeId(u32): 24,      // health
    TypeId(Entity): 0,    // entityå…¨ä½“
}

// æŠ½å‡ºæ™‚
let player_ptr: *const Player = ...;
let health_ptr = player_ptr.offset(24) as *const u32;  // â† ã‚¼ãƒ­ã‚³ã‚¹ãƒˆï¼
```

### 4. Archetype: åŒä¸€æ§‹é€ ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç¾¤

```rust
pub struct Archetype {
    pub(crate) extractor: Arc<Extractor>,
    pub(crate) entities: Vec<(EntityId, EntityData)>,
}
```

**ç›®çš„:** åŒã˜å‹ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’é€£ç¶šãƒ¡ãƒ¢ãƒªã«é…ç½®ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡å‘ä¸Šï¼‰

**ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã®æ±ºå®š:**

```rust
#[derive(Hash, Eq, PartialEq, Clone, Copy, Debug)]
pub(crate) struct ArchetypeId(pub TypeId);
```

åŒã˜Rustå‹ = åŒã˜ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—

**ãƒ¡ãƒ¢ãƒªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ:**

```
World:
  Archetype<Player>: [Player, Player, Player, ...]
  Archetype<Monster>: [Monster, Monster, ...]
  Archetype<Item>: [Item, Item, Item, ...]
```

ã‚­ãƒ£ãƒƒã‚·ãƒ¥å±€æ‰€æ€§ãŒé«˜ãã€ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒé«˜é€Ÿã€‚

### 5. Acquirable: ã‚¹ãƒãƒ¼ãƒˆãƒã‚¤ãƒ³ã‚¿

```rust
pub struct Acquirable<T: 'static> {
    target: NonNull<T>,
    inner: EntityDataInner,  // å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆ
}

impl<T> Deref for Acquirable<T> {
    type Target = T;
    fn deref(&self) -> &T { ... }
}
```

**è²¬å‹™:**

1. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¸ã®å®‰å…¨ãªå‚ç…§
2. ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ã®ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ ç®¡ç†ï¼ˆArcçš„ãªå‹•ä½œï¼‰
3. åŒä¸€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‹ã‚‰ã®è¿½åŠ æŠ½å‡º

**ä½¿ç”¨ä¾‹:**

```rust
let player: Acquirable<Player> = world.extract_component(&id)?;

// Derefã§é€éçš„ã«ã‚¢ã‚¯ã‚»ã‚¹
println!("Name: {}", player.entity.name);

// åŒã˜ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‹ã‚‰åˆ¥ã®å‹ã‚’æŠ½å‡º
let health: Acquirable<u32> = player.extract::<u32>()?;
println!("Health: {}", *health);
```

**å†…éƒ¨ã®å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆ:**

```rust
pub(crate) struct EntityDataInner {
    pub(crate) data: NonNull<u8>,
    pub(crate) counter: NonNull<AtomicUsize>,  // â† å‚ç…§ã‚«ã‚¦ãƒ³ã‚¿
    pub(crate) extractor: Arc<Extractor>,
}
```

- `Acquirable`ãŒã‚¯ãƒ­ãƒ¼ãƒ³ã•ã‚Œã‚‹ã¨`counter`ãŒã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
- æœ€å¾Œã®`Acquirable`ãŒãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚Œã‚‹ã¨ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ã‚’è§£æ”¾

### 6. World: ä¸­å¤®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸

```rust
pub struct World {
    archetypes: DashMap<ArchetypeId, Arc<RwLock<Archetype>>>,
    extractors: DashMap<TypeId, Arc<Extractor>>,
    entity_index: DashMap<EntityId, ArchetypeId>,
    next_entity_id: AtomicU32,
}
```

**è¨­è¨ˆã®æ ¸å¿ƒ:**

1. **DashMap**: ä¸¦è¡ŒHashMapï¼ˆãƒ­ãƒƒã‚¯ãƒ•ãƒªãƒ¼èª­ã¿å–ã‚Šï¼‰
2. **Arc<RwLock<Archetype>>**: ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã”ã¨ã®ç´°ç²’åº¦ãƒ­ãƒƒã‚¯
3. **AtomicU32**: ãƒ­ãƒƒã‚¯ãƒ•ãƒªãƒ¼ãªIDç”Ÿæˆ

**ä¸»è¦API:**

```rust
impl World {
    // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¿½åŠ ï¼ˆ&self - ä¸¦è¡Œå®‰å…¨ï¼‰
    pub fn add_entity<E: Extractable>(&self, entity: E) -> EntityId;
    
    // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å‰Šé™¤ï¼ˆ&self - ä¸¦è¡Œå®‰å…¨ï¼‰
    pub fn remove_entity(&self, entity_id: &EntityId) -> bool;
    
    // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæŠ½å‡ºï¼ˆ&self - ä¸¦è¡Œå®‰å…¨ï¼‰
    pub fn extract_component<T: 'static>(&self, entity_id: &EntityId) 
        -> Option<Acquirable<T>>;
    
    // ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã‚¯ã‚¨ãƒªï¼ˆ&self - ä¸¦è¡Œå®‰å…¨ã€ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰
    pub fn query<T: 'static>(&self) 
        -> impl Iterator<Item = (EntityId, Acquirable<T>)>;
    
    // ä¸¦åˆ—ã‚¯ã‚¨ãƒªï¼ˆ&self - ä¸¦è¡Œå®‰å…¨ï¼‰
    pub fn par_query<T: 'static + Send + Sync>(&self) 
        -> impl ParallelIterator<Item = (EntityId, Acquirable<T>)>;
}
```

**é‡è¦:** ã™ã¹ã¦ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒ`&self`ï¼ˆå…±æœ‰å‚ç…§ï¼‰ã§å‹•ä½œã€‚

### 7. Additional Components: å‹•çš„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**Additional Components**ã¯ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«å¾Œã‹ã‚‰è¿½åŠ ãƒ»å‰Šé™¤ã§ãã‚‹å‹•çš„ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚ä¸»è¦ãªæ§‹é€ ä½“ï¼ˆã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ï¼‰ã«ã¯å«ã¾ã‚Œãªã„ãŒã€ä¸€æ™‚çš„ã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã—ã¾ã™ã€‚

#### è¨­è¨ˆç›®çš„

```rust
// ä¸»è¦æ§‹é€ ï¼ˆã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ï¼‰
#[derive(Extractable)]
pub struct Player {
    pub name: String,
    pub health: u32,
    pub position: Vec3,
}

// ä¸€æ™‚çš„ãªãƒ‡ãƒ¼ã‚¿ï¼ˆAdditionalï¼‰
struct Buff { power: u32, duration: u32 }
struct PoisonEffect { damage: u32, ticks: u32 }
struct QuestProgress { quest_id: u32, progress: u32 }

// å‹•çš„ã«è¿½åŠ /å‰Šé™¤
world.add_additional(&player_id, Buff { power: 10, duration: 5 })?;
world.add_additional(&player_id, PoisonEffect { damage: 2, ticks: 10 })?;
```

#### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ§‹é€ 

```rust
// EntityDataInner å†…éƒ¨
pub(crate) struct EntityDataInner {
    pub(crate) data: NonNull<u8>,
    pub(crate) counter: NonNull<AtomicUsize>,
    pub(crate) extractor: Arc<Extractor>,
    // â†“ Additional components storage
    pub(crate) additional: RwLock<Vec<(TypeId, NonNull<u8>, Arc<Extractor>)>>,
    //                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    //                     å‹ID, ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ã‚¿, Extractorï¼ˆDropç”¨ï¼‰
}
```

**ãƒ¡ãƒ¢ãƒªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ:**

```
EntityData
  â””â”€ inner: EntityDataInner
       â”œâ”€ data: NonNull<u8>  â”€â”€â”€â”€â†’ Box<Player>
       â”œâ”€ counter: NonNull<AtomicUsize>
       â”œâ”€ extractor: Arc<Extractor>
       â””â”€ additional: RwLock<Vec<...>>
            â”œâ”€ (TypeId(Buff), ptr â†’ Box<Buff>, Arc<Extractor>)
            â”œâ”€ (TypeId(PoisonEffect), ptr â†’ Box<PoisonEffect>, Arc<Extractor>)
            â””â”€ (TypeId(QuestProgress), ptr â†’ Box<QuestProgress>, Arc<Extractor>)
```

#### ä¸»è¦API

```rust
impl World {
    // Additionalã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆæ—¢å­˜ã®å ´åˆã¯ç½®ãæ›ãˆï¼‰
    pub fn add_additional<T: Extractable>(&self, entity_id: &EntityId, component: T) 
        -> Result<(), &'static str>;
    
    // Additionalã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æŠ½å‡º
    pub fn extract_additional<T: 'static>(&self, entity_id: &EntityId) 
        -> Option<Acquirable<T>>;
    
    // Additionalã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å­˜åœ¨ç¢ºèª
    pub fn has_additional<T: 'static>(&self, entity_id: &EntityId) -> bool;
    
    // Additionalã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å‰Šé™¤
    pub fn remove_additional<T: 'static>(&self, entity_id: &EntityId) -> bool;
    
    // Additionalã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨å…±ã«ã‚¯ã‚¨ãƒª
    pub fn query_with<T: 'static, A: AdditionalTuple>(&self) 
        -> impl Iterator<Item = (EntityId, Acquirable<T>, A::Output)>;
}
```

#### ä½¿ç”¨ä¾‹

**1. åŸºæœ¬çš„ãªè¿½åŠ ãƒ»å‰Šé™¤:**

```rust
// ãƒãƒ•ã‚’è¿½åŠ 
world.add_additional(&player_id, Buff { power: 10, duration: 5 })?;

// ãƒãƒ•ã‚’å–å¾—
if let Some(buff) = world.extract_additional::<Buff>(&player_id) {
    println!("Power: {}", buff.power);
}

// ãƒãƒ•ã‚’å‰Šé™¤
world.remove_additional::<Buff>(&player_id);
```

**2. ç½®ãæ›ãˆ:**

```rust
// æ—¢å­˜ã®BuffãŒã‚ã‚Œã°ç½®ãæ›ãˆ
world.add_additional(&player_id, Buff { power: 20, duration: 10 })?;
```

**3. Additionalã¨å…±ã«ã‚¯ã‚¨ãƒª:**

```rust
// å˜ä¸€ã®Additional
for (id, player, buff) in world.query_with::<Player, (Buff,)>() {
    // Buffã‚’æŒã¤Playerã®ã¿
    println!("{} has buff power {}", player.name, buff.power);
}

// è¤‡æ•°ã®Additionalï¼ˆæœ€å¤§6å€‹ã¾ã§ï¼‰
for (id, player, (buff, poison)) in world.query_with::<Player, (Buff, PoisonEffect)>() {
    // Buffã¨PoisonEffectã®ä¸¡æ–¹ã‚’æŒã¤Playerã®ã¿
    println!("{} has buff and poison", player.name);
}
```

#### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§

| æ“ä½œ | è¨ˆç®—é‡ | å‚™è€ƒ |
|------|-------|------|
| `add_additional` | O(n) | n = æ—¢å­˜Additionalæ•°ï¼ˆé€šå¸¸2-3å€‹ï¼‰ |
| `extract_additional` | O(n) | ç·šå½¢æ¢ç´¢ |
| `has_additional` | O(n) | ç·šå½¢æ¢ç´¢ |
| `remove_additional` | O(n) | ç·šå½¢æ¢ç´¢ + swap_remove |
| `query_with` | O(m Ã— n) | m = ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ•°ã€n = Additionalæ•° |

**æœ€é©åŒ–ã®è€ƒæ…®:**

- Additionalã¯é€šå¸¸2-3å€‹ç¨‹åº¦ã‚’æƒ³å®šï¼ˆãƒãƒ•ã€ãƒ‡ãƒãƒ•ã€ã‚¯ã‚¨ã‚¹ãƒˆç­‰ï¼‰
- ç·šå½¢æ¢ç´¢ã¯å°è¦æ¨¡ã§ã¯ååˆ†é«˜é€Ÿ
- å°†æ¥çš„ã«SmallVecã‚„HashMapã¸ã®åˆ‡ã‚Šæ›¿ãˆã‚‚æ¤œè¨å¯èƒ½

#### ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ— vs Additional

| ç‰¹å¾´ | ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ï¼ˆä¸»è¦æ§‹é€ ï¼‰ | Additionalï¼ˆå‹•çš„ï¼‰ |
|------|----------------------|-------------------|
| **å®šç¾©** | structå®šç¾©æ™‚ã«å›ºå®š | å®Ÿè¡Œæ™‚ã«è¿½åŠ /å‰Šé™¤ |
| **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹** | â­â­â­â­â­ é«˜é€Ÿ | â­â­â­ ä¸­é€Ÿ |
| **ãƒ¡ãƒ¢ãƒªåŠ¹ç‡** | â­â­â­â­â­ é€£ç¶šé…ç½® | â­â­â­ å€‹åˆ¥ç¢ºä¿ |
| **æŸ”è»Ÿæ€§** | â­â­ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚å›ºå®š | â­â­â­â­â­ å‹•çš„ |
| **ç”¨é€”** | å¿…é ˆãƒ‡ãƒ¼ã‚¿ã€æ°¸ç¶šçš„ | ä¸€æ™‚çš„ã€ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ« |

**ä½¿ã„åˆ†ã‘ã‚¬ã‚¤ãƒ‰:**

```rust
// âœ… ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã«å«ã‚ã‚‹ã¹ã
struct Player {
    name: String,      // å¿…é ˆ
    health: u32,       // å¿…é ˆ
    position: Vec3,    // å¿…é ˆ
}

// âœ… Additionalã«ã™ã¹ã
struct Buff { power: u32, duration: u32 }        // ä¸€æ™‚çš„
struct QuestProgress { quest_id: u32 }           // ã‚ªãƒ—ã‚·ãƒ§ãƒ³
struct TempMarker { reason: String }             // ãƒ‡ãƒãƒƒã‚°ç”¨

// âŒ Optionã§ç„¡é§„ã«ãƒ¡ãƒ¢ãƒªã‚’æ¶ˆè²»ã™ã‚‹
struct Player {
    name: String,
    health: u32,
    buff: Option<Buff>,           // ã™ã¹ã¦ã®Playerã§16ãƒã‚¤ãƒˆæ¶ˆè²»
    quest: Option<QuestProgress>, // ã™ã¹ã¦ã®Playerã§8ãƒã‚¤ãƒˆæ¶ˆè²»
}
```

#### ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãƒ†ã‚£

```rust
// ä¸¦è¡Œè¿½åŠ ï¼ˆç•°ãªã‚‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼‰
thread::spawn(|| world.add_additional(&id1, Buff { ... }));
thread::spawn(|| world.add_additional(&id2, Buff { ... }));
// â† å®Œå…¨ä¸¦åˆ—ï¼ˆç•°ãªã‚‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼‰

// ä¸¦è¡Œè¿½åŠ ï¼ˆåŒä¸€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼‰
thread::spawn(|| world.add_additional(&id, Buff { ... }));
thread::spawn(|| world.add_additional(&id, PoisonEffect { ... }));
// â† RwLockã®æ›¸ãè¾¼ã¿ãƒ­ãƒƒã‚¯ã§ç›´åˆ—åŒ–ï¼ˆå®‰å…¨ï¼‰
```

**ãƒ­ãƒƒã‚¯æˆ¦ç•¥:**

- `add_additional`: RwLockã®æ›¸ãè¾¼ã¿ãƒ­ãƒƒã‚¯ï¼ˆçŸ­æ™‚é–“ï¼‰
- `extract_additional`: RwLockã®èª­ã¿å–ã‚Šãƒ­ãƒƒã‚¯ï¼ˆä¸¦åˆ—å¯èƒ½ï¼‰
- `has_additional`: RwLockã®èª­ã¿å–ã‚Šãƒ­ãƒƒã‚¯ï¼ˆä¸¦åˆ—å¯èƒ½ï¼‰
- `remove_additional`: RwLockã®æ›¸ãè¾¼ã¿ãƒ­ãƒƒã‚¯ï¼ˆçŸ­æ™‚é–“ï¼‰

#### å®Ÿè£…ã®åˆ¶ç´„

**1. å‹ã®ä¸€æ„æ€§:**

```rust
// âŒ åŒã˜å‹ã‚’è¤‡æ•°è¿½åŠ ã§ããªã„
world.add_additional(&id, Buff { power: 10, duration: 5 })?;
world.add_additional(&id, Buff { power: 20, duration: 10 })?;
// â†‘ 2ã¤ç›®ãŒ1ã¤ç›®ã‚’ç½®ãæ›ãˆã‚‹
```

**å›é¿ç­–:**

```rust
// New type patternã§åŒºåˆ¥
struct AttackBuff(Buff);
struct DefenseBuff(Buff);

world.add_additional(&id, AttackBuff(Buff { power: 10, duration: 5 }))?;
world.add_additional(&id, DefenseBuff(Buff { power: 5, duration: 10 }))?;
```

**2. Extractableãƒˆãƒ¬ã‚¤ãƒˆå¿…é ˆ:**

```rust
// âŒ Extractableã§ãªã„å‹ã¯è¿½åŠ ã§ããªã„
world.add_additional(&id, 42u32)?;  // ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼

// âœ… Extractableã‚’å®Ÿè£…
#[derive(Extractable)]
struct Counter(u32);
world.add_additional(&id, Counter(42))?;
```

#### ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

**1. ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹åŠ¹æœ:**

```rust
// ãƒãƒ•ãƒ»ãƒ‡ãƒãƒ•ã‚·ã‚¹ãƒ†ãƒ 
world.add_additional(&player_id, AttackBuff { power: 50, duration: 10 })?;
world.add_additional(&player_id, PoisonEffect { damage: 5, ticks: 20 })?;

// æ¯ãƒ•ãƒ¬ãƒ¼ãƒ ã®å‡¦ç†
for (id, player) in world.query::<Player>() {
    // ãƒãƒ•ã‚’ç¢ºèª
    if let Some(buff) = world.extract_additional::<AttackBuff>(&id) {
        apply_attack_bonus(player, buff.power);
    }
    
    // ãƒ‡ãƒãƒ•ã‚’ç¢ºèª
    if let Some(poison) in world.extract_additional::<PoisonEffect>(&id) {
        apply_poison_damage(player, poison.damage);
    }
}
```

**2. ã‚¯ã‚¨ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ :**

```rust
// ã‚¯ã‚¨ã‚¹ãƒˆé€²è¡ŒçŠ¶æ³ã‚’å‹•çš„ã«è¿½åŠ 
world.add_additional(&player_id, QuestProgress {
    quest_id: 101,
    progress: 0,
})?;

// ã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†ã§å‰Šé™¤
world.remove_additional::<QuestProgress>(&player_id);
```

**3. ãƒ‡ãƒãƒƒã‚°ãƒãƒ¼ã‚«ãƒ¼:**

```rust
// ãƒ‡ãƒãƒƒã‚°ç”¨ã®ä¸€æ™‚ãƒãƒ¼ã‚«ãƒ¼
#[cfg(debug_assertions)]
world.add_additional(&entity_id, DebugMarker {
    reason: "Investigation".to_string(),
    timestamp: Instant::now(),
})?;
```

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©³ç´°

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

#### 1. ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç™»éŒ²ãƒ•ãƒ­ãƒ¼

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¼ãƒ‰:
  Player { entity, health } ã‚’ä½œæˆ
           â†“
  world.add_entity(player)
           â†“
World::add_entity():
  1. AtomicU32ã§EntityIdç”Ÿæˆï¼ˆãƒ­ãƒƒã‚¯ãƒ•ãƒªãƒ¼ï¼‰
  2. Extractorã‚’å–å¾—ã¾ãŸã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ï¼ˆDashMapï¼‰
  3. EntityDataã‚’Boxç¢ºä¿ã—ã¦ãƒã‚¤ãƒ³ã‚¿åŒ–
  4. ArchetypeIdã‚’è¨ˆç®—ï¼ˆTypeIdï¼‰
  5. Archetypeã‚’å–å¾—ã¾ãŸã¯ä½œæˆï¼ˆDashMapï¼‰
  6. Archetype.write().add_entity() ï¼ˆç´°ç²’åº¦ãƒ­ãƒƒã‚¯ï¼‰
  7. entity_indexã«ç™»éŒ²ï¼ˆDashMapï¼‰
           â†“
çµæœ: EntityIdè¿”å´
```

**ä¸¦è¡Œæ€§:**

- ç•°ãªã‚‹ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã¸ã®è¿½åŠ  â†’ å®Œå…¨ä¸¦åˆ—
- åŒã˜ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã¸ã®è¿½åŠ  â†’ RwLockã§ç›´åˆ—åŒ–ï¼ˆå¿…è¦æœ€å°é™ï¼‰

#### 2. ã‚¯ã‚¨ãƒªå®Ÿè¡Œãƒ•ãƒ­ãƒ¼ï¼ˆqueryï¼‰

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¼ãƒ‰:
  world.query::<Health>()
           â†“
World::query():
  1. ã™ã¹ã¦ã®Archetypeã‚’ã‚¤ãƒ†ãƒ¬ãƒ¼ãƒˆï¼ˆDashMap::iterï¼‰
  2. å„Archetypeã‚’çŸ­æ™‚é–“read lock
  3. has_component::<Health>()ã§ãƒ•ã‚£ãƒ«ã‚¿
  4. ãƒãƒƒãƒã—ãŸã‚‰ iter_component()ã§ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå–å¾—
  5. read lockè§£æ”¾ï¼ˆé‡è¦ï¼ï¼‰
  6. ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’Vecã«åé›†
           â†“
  7. Vec<Vec<(EntityId, Acquirable<T>)>> ã‚’flattenã—ã¦ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿è¿”å´
           â†“
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¼ãƒ‰:
  for (id, health) in iter {
    // ã“ã®æ™‚ç‚¹ã§ãƒ­ãƒƒã‚¯ã¯ä¸€åˆ‡ä¿æŒã—ã¦ã„ãªã„
  }
```

**ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæˆ¦ç•¥:**

- ã‚¯ã‚¨ãƒªæ™‚ã«çŸ­æ™‚é–“ã ã‘ãƒ­ãƒƒã‚¯
- ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆEntityIdã¨å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆå¢—åŠ ï¼‰
- ãƒ­ãƒƒã‚¯è§£æ”¾å¾Œã€ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿æ¶ˆè²»

**ãƒ¡ãƒªãƒƒãƒˆ:**

- ã‚¯ã‚¨ãƒªä¸­ã«ä»–ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãŒã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¿½åŠ å¯èƒ½
- ã‚¯ã‚¨ãƒªåŒå£«ã‚‚ä¸¦åˆ—å®Ÿè¡Œå¯èƒ½
- ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ã®ãƒªã‚¹ã‚¯ã‚¼ãƒ­

**ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•:**

- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡å¢—åŠ ï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¿æŒï¼‰
- ã‚¯ã‚¨ãƒªçµæœã¯ã€Œæ™‚ç‚¹ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã€ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã¯ãªã„ï¼‰

#### 3. ä¸¦åˆ—ã‚¯ã‚¨ãƒªãƒ•ãƒ­ãƒ¼ï¼ˆpar_queryï¼‰

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¼ãƒ‰:
  world.par_query::<Position>()
           â†“
World::par_query():
  1. ã™ã¹ã¦ã®Archetypeã‚’Vecã«åé›†ï¼ˆArc<RwLock>ã®ã‚¯ãƒ­ãƒ¼ãƒ³ï¼‰
  2. Rayon ã® into_par_iter() ã§ä¸¦åˆ—åŒ–
  3. å„ã‚¹ãƒ¬ãƒƒãƒ‰ãŒç‹¬ç«‹ã—ã¦Archetypeã‚’read lock
  4. å„Archetypeã®entitiesã‚’par_iter()ã§ã•ã‚‰ã«ä¸¦åˆ—åŒ–
  5. filter_mapã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæŠ½å‡º
           â†“
  ParallelIteratorè¿”å´
           â†“
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¼ãƒ‰:
  iter.for_each(|(id, pos)| {
    // è¤‡æ•°ã‚¹ãƒ¬ãƒƒãƒ‰ã§ä¸¦åˆ—å®Ÿè¡Œ
  });
```

**ä¸¦è¡Œæ€§:**

- Archetypeé–“: å®Œå…¨ä¸¦åˆ—
- Archetypeå†…: ä¸¦åˆ—ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆRayonï¼‰
- ãƒ­ãƒƒã‚¯ç«¶åˆ: æœ€å°é™ï¼ˆèª­ã¿å–ã‚Šãƒ­ãƒƒã‚¯ã®ã¿ï¼‰

### ãƒ¡ãƒ¢ãƒªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè©³ç´°

#### Worldã®ãƒ¡ãƒ¢ãƒªæ§‹é€ 

```
World
â”œâ”€ archetypes: DashMap<ArchetypeId, Arc<RwLock<Archetype>>>
â”‚    â”œâ”€ ArchetypeId(Player) â†’ Arc<RwLock<
â”‚    â”‚    Archetype {
â”‚    â”‚      extractor: Arc<Extractor>,
â”‚    â”‚      entities: Vec<(EntityId, EntityData)>
â”‚    â”‚        â”œâ”€ (EntityId(0), EntityData { inner: EntityDataInner })
â”‚    â”‚        â”œâ”€ (EntityId(1), EntityData { ... })
â”‚    â”‚        â””â”€ (EntityId(2), EntityData { ... })
â”‚    â”‚    }
â”‚    â”‚  >>
â”‚    â””â”€ ArchetypeId(Monster) â†’ Arc<RwLock<Archetype { ... }>>
â”‚
â”œâ”€ extractors: DashMap<TypeId, Arc<Extractor>>
â”‚    â”œâ”€ TypeId(Player) â†’ Arc<Extractor { offsets: {...}, dropper: ... }>
â”‚    â””â”€ TypeId(Monster) â†’ Arc<Extractor { ... }>
â”‚
â”œâ”€ entity_index: DashMap<EntityId, ArchetypeId>
â”‚    â”œâ”€ EntityId(0) â†’ ArchetypeId(Player)
â”‚    â”œâ”€ EntityId(1) â†’ ArchetypeId(Player)
â”‚    â””â”€ EntityId(2) â†’ ArchetypeId(Monster)
â”‚
â””â”€ next_entity_id: AtomicU32 = 3
```

#### EntityDataã®å†…éƒ¨æ§‹é€ 

```
EntityData
  â””â”€ inner: EntityDataInner
       â”œâ”€ data: NonNull<u8>  â”€â”€â”€â”€â†’ Box<Player> {
       â”‚                              entity: Entity { name: "Hero" },
       â”‚                              health: 100
       â”‚                            }
       â”œâ”€ counter: NonNull<AtomicUsize>  â”€â”€â”€â”€â†’ AtomicUsize(1)  // å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆ
       â””â”€ extractor: Arc<Extractor>  â”€â”€â”€â”€â†’ [å…±æœ‰Extractor]
```

**å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã®å‹•ä½œ:**

```rust
// 1. ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¿½åŠ æ™‚
let data = EntityData::new(player, extractor);
// counter = 1

// 2. ã‚¯ã‚¨ãƒªã§Acquirableã‚’å–å¾—
let acq1 = world.extract_component::<Player>(&id)?;
// counter = 2 (EntityDataãŒArchetypeã«1ã¤ã€Acquirableã«1ã¤)

// 3. ã•ã‚‰ã«æŠ½å‡º
let acq2 = acq1.extract::<String>()?;
// counter = 3 (inner ãŒ clone ã•ã‚Œã‚‹)

// 4. AcquirableãŒãƒ‰ãƒ­ãƒƒãƒ—
drop(acq2);  // counter = 2
drop(acq1);  // counter = 1

// 5. ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å‰Šé™¤
world.remove_entity(&id);
// counter = 0 â†’ ãƒ‡ãƒ¼ã‚¿è§£æ”¾ã€dropperãŒå‘¼ã°ã‚Œã‚‹
```

### ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ vs å®Ÿè¡Œæ™‚

| å‡¦ç† | ã‚¿ã‚¤ãƒŸãƒ³ã‚° | å†…å®¹ |
|------|-----------|------|
| **ExtractionMetadataç”Ÿæˆ** | ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ | derive(Extractable)ãƒã‚¯ãƒ­ãŒå±•é–‹ |
| **ã‚ªãƒ•ã‚»ãƒƒãƒˆè¨ˆç®—** | ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ | `offset_of!`ãƒã‚¯ãƒ­ã§é™çš„è¨ˆç®— |
| **Extractoræ§‹ç¯‰** | åˆå›add_entityæ™‚ | ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰HashMapæ§‹ç¯‰ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ |
| **å‹æŠ½å‡º** | å®Ÿè¡Œæ™‚ | HashMap<TypeId, usize>ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ— |
| **ãƒã‚¤ãƒ³ã‚¿æ¼”ç®—** | å®Ÿè¡Œæ™‚ | `ptr.add(offset)`ã€ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã•ã‚Œã‚‹ |

**ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§:**

```rust
// ç–‘ä¼¼ã‚³ãƒ¼ãƒ‰: extract<Health>()ã®å®Ÿä½“
fn extract<Health>(data: *const Player) -> Option<*const Health> {
    let offset = extractor.offsets.get(&TypeId::of::<Health>())?;
    // â†“ HashMapãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã ãŒã€Extractorã¯å…±æœ‰ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ã‚‹ãŸã‚é«˜é€Ÿ
    Some(unsafe { data.add(*offset) as *const Health })
    // â†‘ ãƒã‚¤ãƒ³ã‚¿æ¼”ç®—ã¯CPU 1å‘½ä»¤ã€ã‚¼ãƒ­ã‚³ã‚¹ãƒˆ
}
```

---

## ä¸¦è¡Œå‡¦ç†ãƒ¢ãƒ‡ãƒ«

### ãƒ­ãƒƒã‚¯æˆ¦ç•¥

**éšå±¤çš„ãƒ­ãƒƒã‚¯ãƒ•ãƒªãƒ¼è¨­è¨ˆ:**

```
Level 1: Worldæ§‹é€ ä½“è‡ªä½“
  â†’ ãƒ­ãƒƒã‚¯ãªã—ï¼ˆã™ã¹ã¦ &self APIï¼‰

Level 2: DashMapï¼ˆarchetypes, extractors, entity_indexï¼‰
  â†’ å†…éƒ¨ã‚·ãƒ£ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã€ãƒ­ãƒƒã‚¯ãƒ•ãƒªãƒ¼èª­ã¿å–ã‚Š

Level 3: Archetype
  â†’ RwLockï¼ˆèª­ã¿å–ã‚Šä¸¦åˆ—ã€æ›¸ãè¾¼ã¿æ’ä»–ï¼‰

Level 4: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…éƒ¨
  â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¶å¾¡ï¼ˆAtomic, Mutex, RwLockï¼‰
```

### ä¸¦è¡Œæ€§ã®ãƒ‘ã‚¿ãƒ¼ãƒ³

#### ãƒ‘ã‚¿ãƒ¼ãƒ³1: ç•°ãªã‚‹ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã¸ã®æ“ä½œï¼ˆå®Œå…¨ä¸¦åˆ—ï¼‰

```rust
// ã‚¹ãƒ¬ãƒƒãƒ‰1
world.add_entity(Player { ... });  // Player archetype ã‚’ãƒ­ãƒƒã‚¯

// ã‚¹ãƒ¬ãƒƒãƒ‰2ï¼ˆåŒæ™‚å®Ÿè¡Œï¼‰
world.add_entity(Monster { ... }); // Monster archetype ã‚’ãƒ­ãƒƒã‚¯

// ã‚¹ãƒ¬ãƒƒãƒ‰3ï¼ˆåŒæ™‚å®Ÿè¡Œï¼‰
world.query::<Item>();        // Item archetype ã‚’èª­ã¿å–ã‚Šãƒ­ãƒƒã‚¯
```

**ãƒ­ãƒƒã‚¯ç«¶åˆ:** ãªã—

#### ãƒ‘ã‚¿ãƒ¼ãƒ³2: åŒä¸€ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã¸ã®èª­ã¿å–ã‚Šï¼ˆä¸¦åˆ—å¯èƒ½ï¼‰

```rust
// ã‚¹ãƒ¬ãƒƒãƒ‰1
for (id, player) in world.query::<Player>() {
    // èª­ã¿å–ã‚Šãƒ­ãƒƒã‚¯ï¼ˆçŸ­æ™‚é–“ã€ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå¾Œè§£æ”¾ï¼‰
}

// ã‚¹ãƒ¬ãƒƒãƒ‰2ï¼ˆåŒæ™‚å®Ÿè¡Œï¼‰
for (id, player) in world.query::<Player>() {
    // åŒã˜Archetypeã«èª­ã¿å–ã‚Šãƒ­ãƒƒã‚¯ï¼ˆä¸¦åˆ—OKï¼‰
}

// ã‚¹ãƒ¬ãƒƒãƒ‰3ï¼ˆåŒæ™‚å®Ÿè¡Œï¼‰
let player = world.extract_component::<Player>(&id)?;
// èª­ã¿å–ã‚Šãƒ­ãƒƒã‚¯ï¼ˆä¸¦åˆ—OKï¼‰
```

**ãƒ­ãƒƒã‚¯ç«¶åˆ:** ãªã—ï¼ˆRwLockã®èª­ã¿å–ã‚Šã¯è¤‡æ•°ã‚¹ãƒ¬ãƒƒãƒ‰åŒæ™‚å¯èƒ½ï¼‰

#### ãƒ‘ã‚¿ãƒ¼ãƒ³3: åŒä¸€ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã¸ã®æ›¸ãè¾¼ã¿ï¼ˆç›´åˆ—åŒ–ï¼‰

```rust
// ã‚¹ãƒ¬ãƒƒãƒ‰1
world.add_entity(Player { ... });
// Player archetype ã® write() ãƒ­ãƒƒã‚¯å–å¾—
// â† ã“ã®é–“ã€ä»–ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã¯ãƒ–ãƒ­ãƒƒã‚¯

// ã‚¹ãƒ¬ãƒƒãƒ‰2ï¼ˆå¾…æ©Ÿï¼‰
world.add_entity(Player { ... });
// ã‚¹ãƒ¬ãƒƒãƒ‰1ã®ãƒ­ãƒƒã‚¯è§£æ”¾å¾…ã¡
```

**ãƒ­ãƒƒã‚¯ç«¶åˆ:** ã‚ã‚Šï¼ˆå¿…è¦æœ€å°é™ã€add_entityå†…éƒ¨ã®ã¿ï¼‰

#### ãƒ‘ã‚¿ãƒ¼ãƒ³4: ã‚¯ã‚¨ãƒªä¸­ã®è¿½åŠ ï¼ˆä¸¦åˆ—å¯èƒ½ï¼‰

```rust
// ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰
for (id, player) in world.query::<Player>() {
    // â† ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå–å¾—å¾Œã€ãƒ­ãƒƒã‚¯è§£æ”¾æ¸ˆã¿
    
    // ã“ã®ãƒ«ãƒ¼ãƒ—ä¸­ã«...
}

// åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ï¼ˆåŒæ™‚å®Ÿè¡Œï¼‰
world.add_entity(Player { ... });
// â† æ–°è¦è¿½åŠ ã¯å¯èƒ½ï¼ˆãŸã ã—ã‚¯ã‚¨ãƒªçµæœã«ã¯å«ã¾ã‚Œãªã„ï¼‰
```

**å®‰å…¨æ€§:** ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæˆ¦ç•¥ã«ã‚ˆã‚Šã€ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã¯ä¸€è²«æ€§ã‚’ä¿ã¤

### ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ä¿è¨¼

**1. ãƒ‡ãƒ¼ã‚¿ç«¶åˆã®é˜²æ­¢:**

- ã™ã¹ã¦ã®å…±æœ‰çŠ¶æ…‹ã¯`Sync`å‹ï¼ˆDashMap, Arc, RwLock, AtomicU32ï¼‰
- `unsafe`ã‚³ãƒ¼ãƒ‰ã¯å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã¨ãƒã‚¤ãƒ³ã‚¿æ¼”ç®—ã®ã¿ï¼ˆcarefully auditedï¼‰

**2. use-after-freeã®é˜²æ­¢:**

- `Acquirable`ã«ã‚ˆã‚‹å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆ
- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å‰Šé™¤æ™‚ã‚‚`Acquirable`ãŒç”Ÿãã¦ã„ã‚Œã°ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒ

**3. ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ã®é˜²æ­¢:**

- ãƒ­ãƒƒã‚¯é †åºã®ä¸€è²«æ€§ï¼ˆå¸¸ã«Archetypeå˜ä½ï¼‰
- ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæˆ¦ç•¥ï¼ˆé•·æ™‚é–“ãƒ­ãƒƒã‚¯ä¿æŒãªã—ï¼‰
- ãƒã‚¹ãƒˆã—ãŸãƒ­ãƒƒã‚¯ãªã—

**4. ãƒ¡ãƒ¢ãƒªå®‰å…¨æ€§:**

```rust
unsafe impl Send for Acquirable<T> where T: Send {}
unsafe impl Sync for Acquirable<T> where T: Sync {}
```

- `T`ã®`Send`/`Sync`ã‚’å°Šé‡
- å†…éƒ¨ã®`NonNull<T>`ã¯`Arc`ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ä¿è­·

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§ï¼ˆä¸¦è¡Œå‡¦ç†ï¼‰

**ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœï¼ˆ15,000ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€3ã‚¹ãƒ¬ãƒƒãƒ‰ï¼‰:**

```
Thread 1 (Playerè¿½åŠ ):   5,000ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ in 4.9ms
Thread 2 (Monsterè¿½åŠ ):  5,000ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ in 2.4ms  â† ä¸¦åˆ—ï¼
Thread 3 (Playerè¿½åŠ ):   5,000ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ in 4.9ms  â† ä¸¦åˆ—ï¼

Thread 1 (Playerã‚¯ã‚¨ãƒª):   10,000ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ in 1.2ms
Thread 2 (Monsterã‚¯ã‚¨ãƒª):  5,000ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ in 0.4ms  â† åŒæ™‚å®Ÿè¡Œï¼
Thread 3 (å…¨ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£):  15,000ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ in 1.7ms  â† åŒæ™‚å®Ÿè¡Œï¼
```

**ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£:**

- ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—æ•°ã«æ¯”ä¾‹ï¼ˆã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã”ã¨ã«ç‹¬ç«‹ï¼‰
- CPU ã‚³ã‚¢æ•°ã¾ã§ç·šå½¢ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆç†æƒ³çš„æ¡ä»¶ä¸‹ï¼‰

---

## ãƒ¡ãƒ¢ãƒªãƒ¢ãƒ‡ãƒ«

### ãƒ¡ãƒ¢ãƒªç¢ºä¿æˆ¦ç•¥

**1. ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿:**

```rust
let ptr = Box::into_raw(Box::new(entity)) as *mut u8;
```

- ãƒ’ãƒ¼ãƒ—ç¢ºä¿ï¼ˆBoxï¼‰
- ãƒã‚¤ãƒ³ã‚¿åŒ–ã—ã¦`NonNull<u8>`ã§ä¿æŒ
- å‹æ¶ˆå»ï¼ˆtype erasureï¼‰ã ãŒã€ExtractorãŒå‹æƒ…å ±ã‚’ä¿æŒ

**2. å‚ç…§ã‚«ã‚¦ãƒ³ã‚¿:**

```rust
let counter = Box::leak(Box::new(AtomicUsize::new(1))).into();
```

- ãƒ’ãƒ¼ãƒ—ç¢ºä¿ï¼ˆç‹¬ç«‹ã—ãŸBoxï¼‰
- `leak`ã—ã¦å¯¿å‘½ç®¡ç†ã‚’æ‰‹å‹•åŒ–
- ã™ã¹ã¦ã®`Acquirable`ã§å…±æœ‰

**3. Archetype:**

```rust
pub(crate) entities: Vec<(EntityId, EntityData)>,
```

- `Vec`ã«ã‚ˆã‚‹é€£ç¶šãƒ¡ãƒ¢ãƒªé…ç½®
- å‹•çš„æ‹¡å¼µï¼ˆcapacityå€å¢—æˆ¦ç•¥ï¼‰
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥å±€æ‰€æ€§ãŒé«˜ã„

### ãƒ¡ãƒ¢ãƒªã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰

**ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚ãŸã‚Šã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰:**

```
1ã¤ã®EntityDataã«ã¤ã:
  - EntityId: 4 bytes
  - NonNull<u8>: 8 bytesï¼ˆ64bitï¼‰
  - NonNull<AtomicUsize>: 8 bytes
  - Arc<Extractor>: 8 bytesï¼ˆãƒã‚¤ãƒ³ã‚¿ï¼‰
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  åˆè¨ˆ: 28 bytes + ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æœ¬ä½“ã‚µã‚¤ã‚º
```

**è¿½åŠ ã®ãƒ¡ãƒ¢ãƒª:**

- Extractor: 1å‹ã«ã¤ã1ã¤ï¼ˆå…±æœ‰ï¼‰
- DashMap: å†…éƒ¨ãƒã‚±ãƒƒãƒˆï¼ˆã‚¨ãƒ³ãƒ†ã‚£ãƒªæ•°ã«æ¯”ä¾‹ï¼‰
- ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ: ã‚¯ã‚¨ãƒªå®Ÿè¡Œä¸­ã®ã¿ä¸€æ™‚ç¢ºä¿

### ãƒ¡ãƒ¢ãƒªè§£æ”¾

**ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å‰Šé™¤æ™‚:**

```rust
pub fn remove_entity(&self, entity_id: &EntityId) -> bool {
    // 1. entity_indexã‹ã‚‰å‰Šé™¤ï¼ˆDashMapï¼‰
    let archetype_id = self.entity_index.remove(entity_id)?;
    
    // 2. Archetypeã‹ã‚‰å‰Šé™¤ï¼ˆVec::swap_removeï¼‰
    let archetype = self.archetypes.get(&archetype_id)?;
    let entity_data = archetype.write().remove_entity(entity_id)?;
    
    // 3. EntityDataãŒãƒ‰ãƒ­ãƒƒãƒ—
    drop(entity_data);
    // â†“ ã“ã®æ™‚ç‚¹ã§å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆæ¸›å°‘
    // â†“ counter == 0 ãªã‚‰å®Ÿãƒ‡ãƒ¼ã‚¿ã‚‚è§£æ”¾
}
```

**å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã«ã‚ˆã‚‹é…å»¶è§£æ”¾:**

```rust
impl Drop for EntityDataInner {
    fn drop(&mut self) {
        if self.counter.fetch_sub(1, Ordering::Release) > 1 {
            return;  // ã¾ã ä»–ã«AcquirableãŒå­˜åœ¨
        }
        // æœ€å¾Œã®å‚ç…§ãŒãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸ
        unsafe { (self.extractor.dropper)(self.data) };  // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æœ¬ä½“ã‚’è§£æ”¾
        unsafe { drop(Box::from_raw(self.counter.as_ptr())) };  // ã‚«ã‚¦ãƒ³ã‚¿ã‚’è§£æ”¾
    }
}
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§

### ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœï¼ˆRelease modeï¼‰

**åŸºæœ¬æ“ä½œï¼ˆ10,000ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼‰:**

| æ“ä½œ | æ™‚é–“ | å‚™è€ƒ |
|------|------|------|
| ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¿½åŠ  | ~16ms | Vecæ‹¡å¼µå«ã‚€ |
| å˜ç´”ã‚¯ã‚¨ãƒªï¼ˆiterï¼‰ | ~4ms | ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãªã— |
| å‹æŒ‡å®šã‚¯ã‚¨ãƒª | ~3.4ms | ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°è¾¼ã¿ |
| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæŠ½å‡º | ~100ns | HashMap + ãƒã‚¤ãƒ³ã‚¿æ¼”ç®— |

**ä¸¦åˆ—ã‚¯ã‚¨ãƒªï¼ˆ10,000ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€è¤‡é›‘ãªè¨ˆç®—ï¼‰:**

| æ–¹å¼ | æ™‚é–“ | ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ— |
|------|------|---------------|
| Sequentialï¼ˆqueryï¼‰ | 37ms | 1.0x |
| Parallelï¼ˆpar_queryï¼‰ | 27ms | **1.35x** |

**ä¸¦è¡Œè¿½åŠ ï¼ˆ15,000ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€3ã‚¹ãƒ¬ãƒƒãƒ‰ï¼‰:**

| ã‚¹ãƒ¬ãƒƒãƒ‰ | ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ— | æ™‚é–“ |
|---------|--------------|------|
| Thread 1 | Player | 4.9ms |
| Thread 2 | Monster | 2.4ms |
| Thread 3 | Player | 4.9ms |

**ä¸¦è¡Œã‚¯ã‚¨ãƒªï¼ˆ15,000ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€3ã‚¹ãƒ¬ãƒƒãƒ‰åŒæ™‚ï¼‰:**

| ã‚¹ãƒ¬ãƒƒãƒ‰ | ã‚¯ã‚¨ãƒªå¯¾è±¡ | æ™‚é–“ |
|---------|-----------|------|
| Thread 1 | Player (10,000) | 1.2ms |
| Thread 2 | Monster (5,000) | 0.4ms |
| Thread 3 | å…¨ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ (15,000) | 1.7ms |

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®ãƒã‚¤ãƒ³ãƒˆ

**1. ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ãƒ™ãƒ¼ã‚¹ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸:**

- åŒã˜å‹ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¯é€£ç¶šé…ç½®
- CPU ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡å‘ä¸Š
- SIMDåŒ–ã®ä½™åœ°ï¼ˆå°†æ¥ã®æœ€é©åŒ–ï¼‰

**2. Extractorã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°:**

- å„å‹ã«ã¤ã1ã¤ã®Extractorï¼ˆå…±æœ‰ï¼‰
- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®å†è¨ˆç®—ãªã—
- HashMap ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯1å›ã®ã¿

**3. ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹API:**

```rust
// âŒ é…ã„ï¼ˆVecã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
let players: Vec<_> = world.query_collect::<Player>();
for player in players { ... }

// âœ… é€Ÿã„ï¼ˆã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ï¼‰
for (id, player) in world.query::<Player>() { ... }
```

**4. ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæˆ¦ç•¥:**

- çŸ­æ™‚é–“ã®ãƒ­ãƒƒã‚¯ä¿æŒ
- ãƒ­ãƒƒã‚¯ç«¶åˆã®æœ€å°åŒ–
- ãŸã ã—ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã¯å¢—åŠ ï¼ˆãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ï¼‰

**5. ç´°ç²’åº¦ãƒ­ãƒƒã‚¯:**

```
ç²—ç²’åº¦ãƒ­ãƒƒã‚¯ï¼ˆå¾“æ¥ã®Mutex<World>ï¼‰:
  add_entity(): â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (Worldå…¨ä½“ãƒ­ãƒƒã‚¯)
  query(): â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (Worldå…¨ä½“ãƒ­ãƒƒã‚¯)
  â†’ å®Œå…¨ã«ç›´åˆ—åŒ–

ç´°ç²’åº¦ãƒ­ãƒƒã‚¯ï¼ˆstructecsï¼‰:
  add_entity(Player):  â–ˆâ–ˆ (Playerã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã®ã¿)
  add_entity(Monster):   â–ˆâ–ˆ (Monsterã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã®ã¿) â† ä¸¦åˆ—ï¼
  query(Item):        â–  (Itemã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã®ã¿) â† ä¸¦åˆ—ï¼
```

### ã„ã¤ä¸¦åˆ—ã‚¯ã‚¨ãƒªã‚’ä½¿ã†ã¹ãã‹

**`par_query()` ãŒæœ‰åˆ©ãªå ´åˆ:**

- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ•° > 10,000
- å„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®å‡¦ç†ãŒé‡ã„ï¼ˆè¨ˆç®—ã€I/Oï¼‰
- CPU ãƒã‚¦ãƒ³ãƒ‰ãªå‡¦ç†
- è¤‡æ•°ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã«ã¾ãŸãŒã‚‹ã‚¯ã‚¨ãƒª

**`query()` ãŒæœ‰åˆ©ãªå ´åˆ:**

- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ•° < 10,000
- å„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®å‡¦ç†ãŒè»½ã„ï¼ˆå˜ç´”ãªèª­ã¿å–ã‚Šï¼‰
- ãƒ¡ãƒ¢ãƒªãƒã‚¦ãƒ³ãƒ‰ãªå‡¦ç†
- å˜ä¸€ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã®ã‚¯ã‚¨ãƒª

**ç†ç”±:** ä¸¦åˆ—åŒ–ã«ã¯ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰ç”Ÿæˆã€åŒæœŸï¼‰ãŒã‚ã‚Šã€å‡¦ç†ãŒè»½ã™ãã‚‹ã¨é€†ã«é…ããªã‚‹ã€‚

---

## ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ

### åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸

structecsã¯**69å€‹ã®çµ±åˆãƒ†ã‚¹ãƒˆ**ã§æ¤œè¨¼ã•ã‚Œã¦ãŠã‚Šã€æœ¬ç•ªç’°å¢ƒã§ã®ä½¿ç”¨ã«ååˆ†ãªå“è³ªã‚’ç¢ºä¿ã—ã¦ã„ã¾ã™ã€‚

#### ãƒ†ã‚¹ãƒˆæ§‹æˆ

| ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« | ãƒ†ã‚¹ãƒˆæ•° | ã‚«ãƒãƒ¼ç¯„å›² |
|---------------|---------|-----------|
| **integration_test.rs** | 28 | åŸºæœ¬APIã€ã‚¯ã‚¨ãƒªã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæŠ½å‡ºã€Additional |
| **concurrent_test.rs** | 10 | ä¸¦è¡Œã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¿½åŠ ã€ä¸¦åˆ—ã‚¯ã‚¨ãƒªã€ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ |
| **memory_safety_test.rs** | 10 | ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯æ¤œå‡ºã€Dropå‹•ä½œã€å¤§é‡ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å‡¦ç† |
| **edge_cases_test.rs** | 21 | ç©ºæ“ä½œã€Unicodeã€å¢ƒç•Œå€¤ã€ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—è¿½è·¡ |
| **åˆè¨ˆ** | **69** | **å®Œå…¨ãªæ©Ÿèƒ½æ¤œè¨¼** |

#### ãƒ†ã‚¹ãƒˆè©³ç´°

**1. Integration Testsï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆï¼‰**

```rust
// åŸºæœ¬æ“ä½œ
- add_entity_and_retrieve()      // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¿½åŠ ã¨å–å¾—
- remove_entity_success()        // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å‰Šé™¤
- extract_nested_components()    // ãƒã‚¹ãƒˆã—ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæŠ½å‡º
- query_multiple_archetypes()    // è¤‡æ•°ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã®ã‚¯ã‚¨ãƒª

// ã‚¯ã‚¨ãƒªæ©Ÿèƒ½
- query_basic()             // åŸºæœ¬çš„ãªã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã‚¯ã‚¨ãƒª
- query_empty()             // ç©ºã®ã‚¯ã‚¨ãƒªå‡¦ç†
- par_query_basic()         // ä¸¦åˆ—ã‚¯ã‚¨ãƒª
- query_mixed_types()            // æ··åˆå‹ã®ã‚¯ã‚¨ãƒª

// Additional Componentsï¼ˆ9ãƒ†ã‚¹ãƒˆï¼‰
- add_additional_component()     // Additionalè¿½åŠ 
- extract_additional_component() // AdditionalæŠ½å‡º
- has_additional_component()     // Additionalå­˜åœ¨ç¢ºèª
- remove_additional_component()  // Additionalå‰Šé™¤
- additional_component_replace() // ç½®ãæ›ãˆ
- query_with_single_additional() // å˜ä¸€Additionalã§ã‚¯ã‚¨ãƒª
- query_with_multiple_additional() // è¤‡æ•°Additionalã§ã‚¯ã‚¨ãƒª
- query_with_optional_missing()  // AdditionalãŒãªã„ã‚±ãƒ¼ã‚¹
- additional_survives_removal()  // Acquirableä¿æŒä¸­ã®å‰Šé™¤

// ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹
- entity_id_uniqueness()         // EntityIDã®ä¸€æ„æ€§
- archetype_isolation()          // ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—åˆ†é›¢
```

**2. Concurrent Testsï¼ˆä¸¦è¡Œå‡¦ç†ãƒ†ã‚¹ãƒˆï¼‰**

```rust
// ä¸¦è¡Œã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¿½åŠ ï¼ˆ10-100ã‚¹ãƒ¬ãƒƒãƒ‰ï¼‰
- concurrent_add_entity_10_threads()
- concurrent_add_entity_50_threads()
- concurrent_add_entity_100_threads()

// ä¸¦è¡Œã‚¯ã‚¨ãƒªã¨è¿½åŠ ã®åŒæ™‚å®Ÿè¡Œ
- concurrent_query_and_add()

// å¤§è¦æ¨¡ä¸¦è¡Œå‡¦ç†
- heavy_concurrent_load()        // 10,000ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€10ã‚¹ãƒ¬ãƒƒãƒ‰

// ãƒ‡ãƒ¼ã‚¿ç«¶åˆæ¤œå‡º
- no_data_races_in_queries()
```

**3. Memory Safety Testsï¼ˆãƒ¡ãƒ¢ãƒªå®‰å…¨æ€§ãƒ†ã‚¹ãƒˆï¼‰**

```rust
// ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯æ¤œå‡º
- no_memory_leak_basic()
- no_memory_leak_with_query()
- memory_leak_detection_with_cycles()  // 50,000ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®è¿½åŠ /å‰Šé™¤

// Dropå‹•ä½œ
- proper_drop_on_remove()
- drop_count_verification()

// å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆ
- entity_data_survives_removal()      // å‰Šé™¤å¾Œã‚‚AcquirableãŒæœ‰åŠ¹
- multiple_acquirable_references()    // è¤‡æ•°å‚ç…§ã®ç®¡ç†
```

**4. Edge Cases Testsï¼ˆã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆï¼‰**

```rust
// ç©ºæ“ä½œ
- empty_world_operations()
- remove_nonexistent_entity()
- query_empty_world()

// æ–‡å­—åˆ—ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹
- unicode_string_handling()
- empty_string_handling()
- large_string_handling()

// å¤§é‡ãƒ‡ãƒ¼ã‚¿
- large_entity_count()               // 10,000ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
- rapid_add_remove_cycles()

// ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ç®¡ç†
- multiple_entity_types()
- archetype_tracking()
```

#### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ

```bash
$ cargo test --release

running 69 tests
test concurrent_test::concurrent_add_entity_10_threads ... ok (342ms)
test concurrent_test::concurrent_add_entity_50_threads ... ok (1.8s)
test concurrent_test::concurrent_query_and_add ... ok (245ms)
test integration_test::add_entity_and_retrieve ... ok (0.1ms)
test integration_test::add_additional_component ... ok (0.2ms)
test integration_test::query_with_single_additional ... ok (8ms)
test integration_test::query_with_multiple_additional ... ok (10ms)
test integration_test::query_basic ... ok (12ms)
test memory_safety_test::memory_leak_detection_with_cycles ... ok (3.2s)
test edge_cases_test::large_entity_count ... ok (18ms)
...

test result: ok. 69 passed; 0 failed; 0 ignored; 0 measured
```

**åˆè¨ˆå®Ÿè¡Œæ™‚é–“**: ç´„12ç§’ï¼ˆRelease modeï¼‰

#### å“è³ªä¿è¨¼

âœ… **ãƒ‡ãƒ¼ã‚¿ç«¶åˆã‚¼ãƒ­** - ä¸¦è¡Œãƒ†ã‚¹ãƒˆã§æ¤œè¨¼æ¸ˆã¿  
âœ… **ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã‚¼ãƒ­** - 50,000ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚µã‚¤ã‚¯ãƒ«ã§ç¢ºèª  
âœ… **ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•** - 100ã‚¹ãƒ¬ãƒƒãƒ‰åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆé€šé  
âœ… **APIå®‰å®šæ€§** - 69ãƒ†ã‚¹ãƒˆå…¨ãƒ‘ã‚¹ã€è­¦å‘Šã‚¼ãƒ­  
âœ… **ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹å¯¾å¿œ** - Unicodeã€ç©ºãƒ‡ãƒ¼ã‚¿ã€å¢ƒç•Œå€¤ã™ã¹ã¦ã‚«ãƒãƒ¼  
âœ… **Additionalæ©Ÿèƒ½å®Œå‚™** - CRUDæ“ä½œã€ã‚¯ã‚¨ãƒªçµ±åˆã€ãƒ¡ãƒ¢ãƒªå®‰å…¨æ€§ç¢ºèª  

#### ä»Šå¾Œã®ãƒ†ã‚¹ãƒˆè¨ˆç”»

- **Miriæ¤œè¨¼**: `cargo +nightly miri test` ã§ã®æœªå®šç¾©å‹•ä½œæ¤œå‡º
- **ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯**: ä»–ã®ECSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã®æ€§èƒ½æ¯”è¼ƒ
- **Fuzzing**: ãƒ©ãƒ³ãƒ€ãƒ å…¥åŠ›ã«ã‚ˆã‚‹å …ç‰¢æ€§ãƒ†ã‚¹ãƒˆ
- **çµ±åˆã‚µãƒ³ãƒ—ãƒ«**: å®Ÿè·µçš„ãªã‚²ãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ã®ä¾‹

---

## ä½¿ç”¨ã™ã¹ãã‚±ãƒ¼ã‚¹

### âœ… structecsãŒæœ€é©ãªç”¨é€”

**1. è¤‡é›‘ãªã‚²ãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼**

ä¾‹: Minecraftã‚µãƒ¼ãƒãƒ¼

```rust
// éšå±¤çš„ãªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ§‹é€ 
Entity
  â””â”€ LivingEntity
      â”œâ”€ Player
      â”‚   â”œâ”€ Inventory
      â”‚   â”œâ”€ Permissions
      â”‚   â””â”€ Statistics
      â””â”€ Monster
          â”œâ”€ AI
          â””â”€ LootTable
```

- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ç¶™æ‰¿é–¢ä¿‚ãŒè‡ªç„¶
- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ãŒå¤šæ§˜ï¼ˆSystemã«åã¾ã‚‰ãªã„ï¼‰
- é«˜ã„ä¸¦è¡Œæ€§ï¼ˆè¤‡æ•°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åŒæ™‚å‡¦ç†ï¼‰

**2. MMORPGã‚µãƒ¼ãƒãƒ¼**

- æ•°ä¸‡ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ç®¡ç†
- è¤‡é›‘ãªã‚¯ã‚¨ãƒªï¼ˆç¯„å›²æ¤œç´¢ã€æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿ï¼‰
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ï¼ˆä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ï¼‰
- ä¸¦è¡Œå‡¦ç†ï¼ˆã‚¾ãƒ¼ãƒ³ã”ã¨ã«ç‹¬ç«‹ï¼‰

**3. ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**

ä¾‹: ç‰©ç†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€äº¤é€šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

```rust
// ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã”ã¨ã«ç•°ãªã‚‹çŠ¶æ…‹ã‚’æŒã¤
struct Agent {
    position: RwLock<Vec3>,
    velocity: RwLock<Vec3>,
    state: Mutex<AgentState>,
    memory: Mutex<HashMap<String, Value>>,
}
```

- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®çŠ¶æ…‹ãŒå¤šæ§˜
- ç´°ç²’åº¦ã®ä¸¦è¡Œåˆ¶å¾¡ï¼ˆå„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç‹¬ç«‹ï¼‰
- ã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã€MLï¼‰

**4. è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯**

- ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ãŒéšå±¤çš„
- OOPçš„ãªè¨­è¨ˆãŒè‡ªç„¶
- å‹•çš„ãªå‹æŠ½å‡ºãŒå¿…è¦
- ä¸¦è¡Œãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†

### âŒ structecsãŒä¸å‘ããªç”¨é€”

**1. ã‚·ãƒ³ãƒ—ãƒ«ãªã‚²ãƒ¼ãƒ **

- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒå˜ç´”ï¼ˆPlayer, Enemy, Bulletç¨‹åº¦ï¼‰
- å¾“æ¥ã®ECSï¼ˆBevyï¼‰ã§ååˆ†
- Systemãƒ‘ã‚¿ãƒ¼ãƒ³ãŒãƒ•ã‚£ãƒƒãƒˆ

**2. æœ€å¤§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é‡è¦–**

- ãƒã‚¤ã‚¯ãƒ­ç§’å˜ä½ã®æœ€é©åŒ–ãŒå¿…è¦
- ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®å®Œå…¨åˆ¶å¾¡
- SIMDå‘½ä»¤ã®æ‰‹å‹•æœ€é©åŒ–
- â†’ ç”Ÿã®ãƒ¡ãƒ¢ãƒªæ“ä½œã‚„Custom ECSã®æ–¹ãŒè‰¯ã„

**3. é™çš„ãªå‹ã‚·ã‚¹ãƒ†ãƒ ã§å®Œçµ**

- ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ã™ã¹ã¦ã®å‹ãŒæ±ºå®š
- å‹•çš„æŠ½å‡ºãŒä¸è¦
- â†’ å¾“æ¥ã®ECSã®å‹å®‰å…¨æ€§ã‚’æ´»ã‹ã›ã‚‹

**4. æ—¢å­˜ã®ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã«ä¾å­˜**

- Bevyãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½¿ã„ãŸã„
- specs/hecs ã®è³‡ç”£ãŒã‚ã‚‹
- â†’ ç§»è¡Œã‚³ã‚¹ãƒˆãŒé«˜ã„

### è¦ä»¶ãƒãƒˆãƒªãƒƒã‚¯ã‚¹

| è¦ä»¶ | é‡è¦åº¦ | structecsé©åˆåº¦ |
|------|--------|----------------|
| éšå±¤çš„ãƒ‡ãƒ¼ã‚¿æ§‹é€  | é«˜ | â­â­â­â­â­ |
| æŸ”è»Ÿãªã‚¯ã‚¨ãƒª | é«˜ | â­â­â­â­â­ |
| ä¸¦è¡Œå‡¦ç† | é«˜ | â­â­â­â­â­ |
| å‹•çš„å‹æŠ½å‡º | ä¸­ | â­â­â­â­â­ |
| Systemãªã—ã®è‡ªç”±åº¦ | ä¸­ | â­â­â­â­â­ |
| ã‚·ãƒ³ãƒ—ãƒ«ãªAPI | ä¸­ | â­â­â­â­ |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | ä¸­ | â­â­â­â­ |
| å‹å®‰å…¨æ€§ï¼ˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ï¼‰ | ä½ | â­â­â­ |
| ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ  | ä½ | â­ |

---

## æŠ€è¡“çš„åˆ¶ç´„ã¨è¨­è¨ˆåˆ¤æ–­

### 1. ãªãœwrite APIã‚’æä¾›ã—ãªã„ã®ã‹

**åˆ¤æ–­:** `query_mut()` ã‚„ `extract_component_mut()` ã¯**æä¾›ã—ãªã„**ã€‚

**ç†ç”±:**

#### (a) Worldå…¨ä½“ã®ãƒ­ãƒƒã‚¯ç«¶åˆ

```rust
// ã‚‚ã—ã“ã‚“ãªAPIãŒã‚ã£ãŸã‚‰...
for (id, mut player) in world.query_mut::<Player>() {
    player.health += 10;
    // â† ã“ã®é–“ã€WorldãŒæ’ä»–ãƒ­ãƒƒã‚¯
    // â† ä»–ã®ã™ã¹ã¦ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãŒãƒ–ãƒ­ãƒƒã‚¯
}
```

**å•é¡Œ:**

- Worldã®**ã™ã¹ã¦ã®ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—**ãŒæ›¸ãè¾¼ã¿ãƒ­ãƒƒã‚¯
- èª­ã¿å–ã‚Šã™ã‚‰ãƒ–ãƒ­ãƒƒã‚¯
- ä¸¦è¡Œæ€§ãŒå®Œå…¨ã«å¤±ã‚ã‚Œã‚‹

#### (b) æŸ”è»Ÿæ€§ã®å–ªå¤±

```rust
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç®¡ç†ã™ã‚‹å ´åˆ
struct Player {
    name: String,            // ä¸å¤‰
    health: AtomicU32,       // ãƒ­ãƒƒã‚¯ãƒ•ãƒªãƒ¼å¤‰æ›´å¯èƒ½
    inventory: Mutex<Vec<Item>>, // å¿…è¦ãªæ™‚ã ã‘ãƒ­ãƒƒã‚¯
}

// å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§æœ€é©ãªãƒ­ãƒƒã‚¯æˆ¦ç•¥ã‚’é¸æŠã§ãã‚‹
```

```rust
// ã‚‚ã—WorldãŒwrite APIã‚’æä¾›ã—ãŸã‚‰...
for (id, mut player) in world.query_mut::<Player>() {
    // Playerå…¨ä½“ãŒå¯å¤‰å€Ÿç”¨
    // â†’ ç´°ã‹ã„åˆ¶å¾¡ä¸å¯èƒ½
}
```

#### (c) ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ã®ãƒªã‚¹ã‚¯

```rust
// å±é™ºãªãƒ‘ã‚¿ãƒ¼ãƒ³
let mut player = world.extract_component_mut::<Player>(&id1)?;
// â† Playerå…¨ä½“ãŒæ›¸ãè¾¼ã¿ãƒ­ãƒƒã‚¯

let other = world.extract_component_mut::<Player>(&id2)?;
// â† åŒã˜ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã«å†åº¦æ›¸ãè¾¼ã¿ãƒ­ãƒƒã‚¯
// â†“ ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ï¼ï¼ˆRwLockã¯å†å…¥ä¸å¯ï¼‰
```

**ä»£æ›¿æ¡ˆï¼ˆç¾åœ¨ã®è¨­è¨ˆï¼‰:**

```rust
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ãƒƒã‚¯ç²’åº¦ã‚’åˆ¶å¾¡
let player = world.extract_component::<Mutex<PlayerState>>(&id)?;
let mut state = player.lock().unwrap();
// â† ã“ã®Playerã®stateã®ã¿ãƒ­ãƒƒã‚¯ã€ä»–ã¯ç„¡é–¢ä¿‚
```

### 2. ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ vs ãƒ©ã‚¤ãƒ–ãƒ“ãƒ¥ãƒ¼

**åˆ¤æ–­:** ã‚¯ã‚¨ãƒªã¯**ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ**ã‚’è¿”ã™ã€‚

**ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•:**

| æ–¹å¼ | ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ |
|------|---------|-----------|
| ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆæ¡ç”¨ï¼‰ | ãƒ­ãƒƒã‚¯æ™‚é–“æœ€å°ã€ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ãªã—ã€ã‚¯ã‚¨ãƒªä¸­ã®è¿½åŠ OK | ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã€ä¸€è²«æ€§ã¯æ™‚ç‚¹ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ |
| ãƒ©ã‚¤ãƒ–ãƒ“ãƒ¥ãƒ¼ | ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜  | é•·æ™‚é–“ãƒ­ãƒƒã‚¯ã€ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ãƒªã‚¹ã‚¯ã€ä¸¦è¡Œæ€§ä½ä¸‹ |

**æ¡ç”¨ç†ç”±:**

- ä¸¦è¡Œå‡¦ç†ã‚’æœ€å„ªå…ˆ
- ã‚²ãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ã§ã¯ã€Œå°‘ã—å‰ã®çŠ¶æ…‹ã€ã§ååˆ†ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ å˜ä½ã®é…å»¶ã¯è¨±å®¹ï¼‰
- ãƒ¡ãƒ¢ãƒªã¯æ¯”è¼ƒçš„æ½¤æ²¢ï¼ˆå‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã®ã‚³ã‚¹ãƒˆã¯å°ã•ã„ï¼‰

### 3. å‹•çš„å‹æŠ½å‡º vs ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚å‹å®‰å…¨

**åˆ¤æ–­:** å®Ÿè¡Œæ™‚ã®`TypeId`ãƒ™ãƒ¼ã‚¹æŠ½å‡ºã‚’æ¡ç”¨ã€‚

**ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•:**

```rust
// structecsï¼ˆå®Ÿè¡Œæ™‚ï¼‰
let health = entity.extract::<u32>()?;  // Option<Acquirable<u32>>
// â†‘ å®Ÿè¡Œæ™‚ã«å‹ãŒåˆã‚ãªã‘ã‚Œã°None

// å¾“æ¥ã®ECSï¼ˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ï¼‰
fn system(query: Query<&Health, With<Player>>) { ... }
// â†‘ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«å‹ãƒã‚§ãƒƒã‚¯ã€å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼ãªã—
```

**æ¡ç”¨ç†ç”±:**

- æŸ”è»Ÿæ€§ï¼ˆä»»æ„ã®å‹ã‚’å‹•çš„ã«æŠ½å‡ºå¯èƒ½ï¼‰
- éšå±¤æ§‹é€ ã®ã‚µãƒãƒ¼ãƒˆï¼ˆãƒã‚¹ãƒˆã—ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚æŠ½å‡ºï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‹ã‚’çŸ¥ã‚‰ãªãã¦ã‚‚è‰¯ã„ï¼ˆãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ç­‰ï¼‰

**ä»£å„Ÿ:**

- `Option`ã§å¤±æ•—å¯èƒ½
- å‹ãƒŸã‚¹ãŒã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«æ¤œå‡ºã•ã‚Œãªã„

### 4. Archetypeå¤‰æ›´ã®éã‚µãƒãƒ¼ãƒˆ

**ç¾çŠ¶:** ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¿½åŠ å¾Œã€æ§‹é€ å¤‰æ›´ä¸å¯ã€‚

```rust
// âŒ ç¾åœ¨ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„
world.add_component::<Buff>(&player_id, buff);
world.remove_component::<Debuff>(&player_id);
```

**ç†ç”±:**

#### (a) ãƒã‚¤ãƒ³ã‚¿ç„¡åŠ¹åŒ–

```rust
let health = world.extract_component::<u32>(&id)?;
// â†‘ Playerã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—å†…ã®ãƒã‚¤ãƒ³ã‚¿

world.add_component::<Buff>(&id, buff);
// â†“ PlayerBuffã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã«ç§»å‹•
// â†“ healthãƒã‚¤ãƒ³ã‚¿ãŒç„¡åŠ¹åŒ–ï¼
```

#### (b) å®Ÿè£…è¤‡é›‘æ€§

- ä¸–ä»£ç•ªå·ç®¡ç†ãŒå¿…è¦
- Acquirableã®validation
- ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—é–“ã®ç§»å‹•ã‚³ã‚¹ãƒˆ

**å°†æ¥ã®å¯¾å¿œç­–ï¼ˆæ¤œè¨ä¸­ï¼‰:**

- ä¸–ä»£ç•ªå·ã«ã‚ˆã‚‹ç„¡åŠ¹åŒ–æ¤œå‡º
- `Acquirable::is_valid()` API
- Copy-on-Writeçš„ãªç§»å‹•æˆ¦ç•¥

**ç¾åœ¨ã®å›é¿ç­–:**

```rust
// æœ€åˆã‹ã‚‰å…¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å«ã‚ã‚‹
struct Player {
    health: u32,
    buff: Option<Buff>,  // â† Optionã§è¡¨ç¾
}
```

### 5. unsafe ã‚³ãƒ¼ãƒ‰ã®ä½¿ç”¨

**ä½¿ç”¨ç®‡æ‰€:**

1. **ãƒã‚¤ãƒ³ã‚¿æ¼”ç®—**ï¼ˆextractor.rsï¼‰

```rust
unsafe fn extract_ptr<T: 'static>(&self, data: NonNull<u8>) -> Option<NonNull<T>> {
    let offset = self.offsets.get(&TypeId::of::<T>())?;
    Some(NonNull::new_unchecked(data.as_ptr().add(*offset) as *mut T))
}
```

2. **å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆæ“ä½œ**ï¼ˆentity.rsï¼‰

```rust
impl Clone for EntityDataInner {
    fn clone(&self) -> Self {
        unsafe { self.counter.as_ref().fetch_add(1, Ordering::Relaxed); }
        // ...
    }
}
```

3. **å‹æ¶ˆå»ã¨ãƒ‰ãƒ­ãƒƒãƒ—**ï¼ˆentity.rsï¼‰

```rust
unsafe { (self.extractor.dropper)(self.data) };
```

**å®‰å…¨æ€§ã®ä¿è¨¼:**

- âœ… **ã‚ªãƒ•ã‚»ãƒƒãƒˆè¨ˆç®—**: ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚`offset_of!`ã§æ¤œè¨¼æ¸ˆã¿
- âœ… **ãƒã‚¤ãƒ³ã‚¿ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆ**: Rust ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿è¨¼ã«ä¾å­˜
- âœ… **å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆ**: Arc ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ‰‹å‹•å®Ÿè£…ï¼ˆwell-testedï¼‰
- âœ… **ãƒ‰ãƒ­ãƒƒãƒ—**: Extractorç”Ÿæˆæ™‚ã«å‹æƒ…å ±ä¿æŒã€æ­£ã—ã„ãƒ‰ãƒ­ãƒƒãƒ—é–¢æ•°ç™»éŒ²

**ç›£æŸ»çŠ¶æ³:**

- ã™ã¹ã¦ã®`unsafe`ãƒ–ãƒ­ãƒƒã‚¯ã«ã‚³ãƒ¡ãƒ³ãƒˆ
- å°†æ¥çš„ã«Miriã§æ¤œè¨¼äºˆå®š

---

## ä»Šå¾Œã®æ‹¡å¼µæ–¹å‘

### ãƒ•ã‚§ãƒ¼ã‚º1: åŸºç›¤å®Ÿè£… âœ… å®Œäº†

- âœ… ã‚³ã‚¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆWorld, Entity, Archetypeï¼‰
- âœ… ä¸¦è¡Œå‡¦ç†ï¼ˆDashMap + RwLockï¼‰
- âœ… ã‚¯ã‚¨ãƒªã‚·ã‚¹ãƒ†ãƒ ï¼ˆquery, par_queryï¼‰
- âœ… ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæŠ½å‡ºï¼ˆExtractable derive macroï¼‰
- âœ… ãƒ¡ãƒ¢ãƒªç®¡ç†ï¼ˆå‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã€å®‰å…¨ãªDropï¼‰

### ãƒ•ã‚§ãƒ¼ã‚º2: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– âœ… å®Œäº†

- âœ… Extractorã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°
- âœ… ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæˆ¦ç•¥ã«ã‚ˆã‚‹ãƒ­ãƒƒã‚¯æœ€é©åŒ–
- âœ… ä¸¦åˆ—ã‚¯ã‚¨ãƒªï¼ˆRayonçµ±åˆï¼‰
- âœ… ã‚¼ãƒ­ã‚³ã‚¹ãƒˆæŠ½è±¡åŒ–ï¼ˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã‚ªãƒ•ã‚»ãƒƒãƒˆè¨ˆç®—ï¼‰

### ãƒ•ã‚§ãƒ¼ã‚º3: å“è³ªä¿è¨¼ âœ… å®Œäº†

- âœ… **69å€‹ã®çµ±åˆãƒ†ã‚¹ãƒˆ** - å…¨ãƒ‘ã‚¹ã€è­¦å‘Šã‚¼ãƒ­
- âœ… **ä¸¦è¡Œå‡¦ç†ãƒ†ã‚¹ãƒˆ** - 10-100ã‚¹ãƒ¬ãƒƒãƒ‰ã§æ¤œè¨¼
- âœ… **ãƒ¡ãƒ¢ãƒªå®‰å…¨æ€§ãƒ†ã‚¹ãƒˆ** - 50,000ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚µã‚¤ã‚¯ãƒ«
- âœ… **ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ** - Unicodeã€å¢ƒç•Œå€¤ã€ç©ºæ“ä½œ
- âœ… **Additional Components** - CRUDæ“ä½œã€ã‚¯ã‚¨ãƒªçµ±åˆå®Œäº†
- âœ… **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™** - README.mdã€Architecture.md

### ãƒ•ã‚§ãƒ¼ã‚º4: æ¤œè¨¼ã¨æœ€é©åŒ–ï¼ˆç¾åœ¨ï¼‰

**çŸ­æœŸã‚¿ã‚¹ã‚¯ï¼ˆå„ªå…ˆåº¦ï¼šé«˜ï¼‰**

1. **Miriæ¤œè¨¼**

   ```bash
   cargo +nightly miri test
   ```

   - æœªå®šç¾©å‹•ä½œã®æ¤œå‡º
   - unsafeã‚³ãƒ¼ãƒ‰ã®å®‰å…¨æ€§ç¢ºèª
   - ãƒ¡ãƒ¢ãƒªã‚¢ã‚¯ã‚»ã‚¹ã®å¦¥å½“æ€§æ¤œè¨¼

2. **ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯æ‹¡å……**
   - ä»–ã®ECSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã®æ¯”è¼ƒï¼ˆBevy, specs, hecsï¼‰
   - å„ç¨®æ“ä½œã®ãƒã‚¤ã‚¯ãƒ­ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
   - ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£æ¸¬å®šï¼ˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ•° vs ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼‰

3. **ã‚µãƒ³ãƒ—ãƒ«å……å®Ÿ**
   - å®Ÿè·µçš„ãªã‚²ãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ã®ä¾‹
   - ç‰©ç†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¾‹
   - ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

**ä¸­æœŸã‚¿ã‚¹ã‚¯ï¼ˆæ¤œè¨ä¸­ï¼‰**

4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°**
   - Flamegraphè§£æ
   - ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ç‰¹å®š
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡æ¸¬å®š

5. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå¼·åŒ–**
   - Doctestã®è¿½åŠ 
   - ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ä½œæˆ
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰

6. **APIæ”¹å–„ï¼ˆç ´å£Šçš„å¤‰æ›´ãªã—ï¼‰**
   - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ´—ç·´
   - ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿APIã®æ‹¡å¼µ
   - ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ã®è¿½åŠ 

### ãƒ•ã‚§ãƒ¼ã‚º5: ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰ï¼ˆé•·æœŸï¼‰

**å°†æ¥çš„ãªæ‹¡å¼µï¼ˆç ”ç©¶æ®µéšï¼‰**

7. **ã‚¤ãƒ™ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰**

   ```rust
   world.on_entity_added::<Player>(|id, player| {
       log::info!("Player {} joined!", player.name);
   });
   ```

8. **ã‚¯ã‚¨ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°**
   - LRUã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹é«˜é€ŸåŒ–
   - ä¸–ä»£ç•ªå·ã«ã‚ˆã‚‹ç„¡åŠ¹åŒ–
   - ãƒ›ãƒƒãƒˆãƒ‘ã‚¹ã®æœ€é©åŒ–

9. **SIMDæœ€é©åŒ–**
   - æ•°å€¤è¨ˆç®—ã®ãƒãƒƒãƒå‡¦ç†
   - ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®æœ€é©åŒ–
   - ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å›ºæœ‰ã®æœ€é©åŒ–

10. **ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³**
    - ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ä¿å­˜/å¾©å…ƒ
    - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è»¢é€å¯¾å¿œ
    - ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ç®¡ç†

### éå¯¾å¿œæ©Ÿèƒ½ï¼ˆè¨­è¨ˆæ€æƒ³ã«ã‚ˆã‚Šï¼‰

ä»¥ä¸‹ã®æ©Ÿèƒ½ã¯**æ„å›³çš„ã«ã‚µãƒãƒ¼ãƒˆã—ãªã„**æ–¹é‡ã§ã™ï¼š

âŒ **Query Builder** - structå˜ä½ã®ç®¡ç†ã«ã‚ˆã‚Šä¸è¦  
âŒ **Componentè¿½åŠ /å‰Šé™¤** - ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—å¤‰æ›´ã®è¤‡é›‘æ€§ã‚’å›é¿  
âŒ **Systemå¼·åˆ¶** - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‡ªç”±åº¦ã‚’å„ªå…ˆ  
âŒ **ã‚°ãƒ­ãƒ¼ãƒãƒ«World** - æ˜ç¤ºçš„ãªä¾å­˜æ³¨å…¥ã‚’æ¨å¥¨  

### ãƒªãƒªãƒ¼ã‚¹è¨ˆç”»

**v0.1.0ï¼ˆç¾åœ¨ï¼‰**

- ã‚³ã‚¢æ©Ÿèƒ½å®Œæˆ
- Additional Componentså®Ÿè£…
- 69ãƒ†ã‚¹ãƒˆå…¨ãƒ‘ã‚¹
- åŸºæœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™

**v0.2.0ï¼ˆæ¬¡æœŸï¼‰**

- Miriæ¤œè¨¼å®Œäº†
- ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœå…¬é–‹
- ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰è¿½åŠ 
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

**v1.0.0ï¼ˆå®‰å®šç‰ˆï¼‰**

- APIå‡çµ
- æœ¬ç•ªç’°å¢ƒã§ã®å®Ÿç¸¾
- å®Œå…¨ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- crates.ioå…¬é–‹

---

## ã¾ã¨ã‚

structecsã¯ã€**éšå±¤çš„ãƒ‡ãƒ¼ã‚¿æ§‹é€ **ã¨**é«˜ä¸¦è¡Œæ€§**ã‚’ä¸¡ç«‹ã•ã›ã‚‹ã€æ–°ã—ã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®ECSãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚

### æ ¸å¿ƒçš„ä¾¡å€¤

1. **ãƒ‡ãƒ¼ã‚¿ã¯éšå±¤çš„ã€ã‚¢ã‚¯ã‚»ã‚¹ã¯ãƒ•ãƒ©ãƒƒãƒˆ** - OOPã¨ECSã®è‰¯ã„ã¨ã“å–ã‚Š
2. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¯å¤‰æ€§ã‚’åˆ¶å¾¡** - æœ€é©ãªãƒ­ãƒƒã‚¯æˆ¦ç•¥ã‚’é¸æŠå¯èƒ½
3. **ç´°ç²’åº¦ãƒ­ãƒƒã‚¯** - ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—å˜ä½ã®ä¸¦è¡Œå‡¦ç†
4. **Systemã®æŠ¼ã—ä»˜ã‘ãªã—** - è‡ªç”±ãªãƒ­ã‚¸ãƒƒã‚¯è¨˜è¿°

### é–‹ç™ºçŠ¶æ³

**âœ… æœ¬ç•ªæº–å‚™å®Œäº†ï¼ˆProduction Readyï¼‰**

- âœ… **ã‚³ã‚¢æ©Ÿèƒ½** - Worldã€Entityã€Queryã€Extractã€Additional ã™ã¹ã¦å®Ÿè£…å®Œäº†
- âœ… **69ãƒ†ã‚¹ãƒˆå…¨ãƒ‘ã‚¹** - çµ±åˆã€ä¸¦è¡Œã€ãƒ¡ãƒ¢ãƒªå®‰å…¨æ€§ã€ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹
- âœ… **ã‚¼ãƒ­è­¦å‘Š** - Clippyãƒ»Rustcè­¦å‘Šãªã—
- âœ… **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå®Œå‚™** - README.mdã€Architecture.mdã€ã‚³ãƒ¼ãƒ‰å†…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- âœ… **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¤œè¨¼æ¸ˆã¿** - 10,000ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€100ã‚¹ãƒ¬ãƒƒãƒ‰ä¸¦è¡Œ

### å‘ã„ã¦ã„ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

- âœ… è¤‡é›‘ãªã‚²ãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ï¼ˆMinecraft, MMOï¼‰
- âœ… éšå±¤çš„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ§‹é€ 
- âœ… é«˜ä¸¦è¡Œå‡¦ç†è¦æ±‚
- âœ… æŸ”è»Ÿãªãƒ­ã‚¸ãƒƒã‚¯è¨˜è¿°
- âœ… æ•°åƒã€œæ•°ä¸‡ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ç®¡ç†

### å‘ã„ã¦ã„ãªã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

- âŒ ã‚·ãƒ³ãƒ—ãƒ«ãªã‚²ãƒ¼ãƒ ï¼ˆå¾“æ¥ã®ECSã§ååˆ†ï¼‰
- âŒ æœ€å¤§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¿½æ±‚ï¼ˆãƒã‚¤ã‚¯ãƒ­ç§’å˜ä½ã®æœ€é©åŒ–ï¼‰
- âŒ æ—¢å­˜ECSã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã«ä¾å­˜
- âŒ å®Œå…¨ãªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚å‹å®‰å…¨æ€§ãŒå¿…é ˆ

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

**ã™ãã«å§‹ã‚ã‚‰ã‚Œã‚‹ã“ã¨:**

```rust
// 1. Cargo.toml ã«è¿½åŠ 
[dependencies]
structecs = { path = "structecs" }

// 2. ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å®šç¾©
#[derive(Extractable)]
struct Player {
    name: String,
    health: AtomicU32,
}

// 3. Worldã‚’ä½œæˆã—ã¦ä½¿ã†
let world = World::default();
let id = world.add_entity(Player { /* ... */ });
for (id, player) in world.query::<Player>() {
    // ä¸¦è¡Œå®‰å…¨ãªã‚¢ã‚¯ã‚»ã‚¹
}
```

**æ¤œè¨¼ãƒ»æœ€é©åŒ–:**

1. `cargo test` - å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
2. `cargo bench` - ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯æ¸¬å®š
3. `cargo +nightly miri test` - ãƒ¡ãƒ¢ãƒªå®‰å…¨æ€§æ¤œè¨¼ï¼ˆæ¨å¥¨ï¼‰

### æŠ€è¡“çš„ç‰¹å¾´ã¾ã¨ã‚

| ç‰¹å¾´ | å®Ÿè£… | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|------|------|-----------|
| éšå±¤çš„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | Extractable derive macro | âœ… å®Œæˆ |
| ä¸¦è¡Œã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¿½åŠ  | DashMap + RwLock | âœ… å®Œæˆ |
| ä¸¦åˆ—ã‚¯ã‚¨ãƒª | Rayon par_iter | âœ… å®Œæˆ |
| ãƒ¡ãƒ¢ãƒªå®‰å…¨æ€§ | å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆ + Drop | âœ… æ¤œè¨¼æ¸ˆã¿ |
| ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ | 100ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ†ã‚¹ãƒˆ | âœ… æ¤œè¨¼æ¸ˆã¿ |
| ã‚¼ãƒ­ã‚³ã‚¹ãƒˆæŠ½è±¡åŒ– | ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã‚ªãƒ•ã‚»ãƒƒãƒˆ | âœ… å®Œæˆ |
| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | README + Architecture | âœ… å®Œå‚™ |

structecsã¯ã€**ãƒ‡ãƒ¼ã‚¿æŒ‡å‘è¨­è¨ˆã®æ€§èƒ½**ã¨**ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘ã®è¡¨ç¾åŠ›**ã‚’èåˆã•ã›ãŸã€å®Ÿç”¨çš„ãªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚

**ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v0.1.0ï¼ˆæœ¬ç•ªæº–å‚™å®Œäº†ï¼‰  
**ãƒ©ã‚¤ã‚»ãƒ³ã‚¹**: MIT  
**è²¢çŒ®**: Issueã€PRã‚’æ­“è¿ã—ã¾ã™  
**ã‚µãƒãƒ¼ãƒˆ**: AGENTS.mdã«è¨˜è¼‰ã•ã‚ŒãŸæ–¹é‡ã§å¯¾å¿œã—ã¾ã™

---

*ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€structecsã®è¨­è¨ˆæ€æƒ³ãƒ»å®Ÿè£…è©³ç´°ãƒ»ä½¿ç”¨ã‚¬ã‚¤ãƒ‰ã‚’åŒ…æ‹¬çš„ã«èª¬æ˜ã—ã¦ã„ã¾ã™ã€‚è³ªå•ã‚„æ”¹å–„ææ¡ˆãŒã‚ã‚Œã°ã€GitHubã®Issueã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚*
